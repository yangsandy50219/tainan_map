<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>交通儀表板</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  

	<!-- 引入 Leaflet 的 JavaScript 文件 -->
            <script 
                src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
                crossorigin=""
                ></script>
				
	<!-- 引入 Axios，用於 API 請求 -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; font-size: 14px; }
    .leaflet-control { z-index: 2000 !important; }
    .mouse-position {
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
  
</head>

<body>
  <div id="map"></div>

  <script>
    // 初始化地圖，預設顯示整個台南市
    const map = L.map("map").fitBounds([
      [22.887, 120.007], // 西南角
      [23.413, 120.627]  // 東北角
    ]);

    // 台灣 NLCS 瓦片圖
    const EMap = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
      attribution: '© 國土測繪中心'
    });

    const orthophoto = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', {
      attribution: '© 國土測繪中心'
    });

    // OpenStreetMap
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    });

	// 簡單乾淨的底圖 (Carto Light)
	const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
		subdomains: 'abcd',
		maxZoom: 19
	});


    const basemapLayers = {
      "臺灣通用電子地圖": EMap,
      "正射影像圖": orthophoto,
      "OpenStreetMap": osm,
	  "簡潔底圖": lightBasemap.addTo(map)
    };

    // 底圖切換
    L.control.layers(basemapLayers, null, { position: 'topleft' }).addTo(map);

    //////// 滑鼠位置顯示經緯度 ////////
    var mousePositionControl = L.control({ position: 'bottomleft' });
    mousePositionControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'mouse-position');
      div.innerHTML = '經緯度: ';
      return div;
    };
    mousePositionControl.addTo(map);

    map.on('mousemove', function (e) {
      var latlng = e.latlng;
      document.querySelector('.mouse-position').innerHTML =
        '經緯度：( ' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6) + ' )';
    });

    //////// 回到台南市 ////////
    var infoControl = L.control({ position: 'bottomleft' });
    infoControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = '<b>點擊此處回到台南市</b>';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      div.style.padding = '5px';
      div.style.borderRadius = '5px';
      div.style.fontSize = '16px';
      div.style.fontWeight = 'bold';
      div.style.cursor = 'pointer';
      div.onclick = function () {
        map.fitBounds([
          [22.887, 120.007], // 西南角
          [23.413, 120.627]  // 東北角
        ]);
      };
      return div;
    };
    infoControl.addTo(map);


	
	

	
	/////////////////// 介接 TDX CCTV ///////////////////////
	// 建立 CCTV 圖層群組
  const cityCCTVLayer = L.layerGroup().addTo(map); // 台南市 CCTV 預設開啟
  const highwayCCTVLayer = L.layerGroup();         // 高速公路 CCTV 預設關閉

  // 縣市 CCTV
  var cctvIcon = new L.Icon({
    iconUrl: 'https://i.postimg.cc/W1WmzvsX/security-camera-11203057.png',
    iconSize: [41, 41],
  });

  async function getCCTVData() {
    let url ='https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Tainan?%24format=JSON'; 
    axios.get(url).then(async (res) => {
      let data = await res.data;
      console.log(data.CCTVs);

      for (let j = 0; j < data.CCTVs.length; j++) { 	
        let imgTag = `<img src="${data.CCTVs[j].VideoStreamURL}" width="380" height="240"/>`;
        L.marker([data.CCTVs[j].PositionLat, data.CCTVs[j].PositionLon], {
          icon: cctvIcon, 
          title: 'CCTV'
        }).bindPopup(
          `路名：${data.CCTVs[j].RoadName}</br>${imgTag}`,
          {maxWidth: "640", maxHeight: "480"}
        ).addTo(cityCCTVLayer);
      }
    }).catch((error) => {
      console.log(error);
    });
  }
  getCCTVData();

  // 高速公路 CCTV
  var cctvIcon1 = new L.Icon({
    iconUrl: 'https://i.postimg.cc/4y0yH2L2/CCTV.png',
    iconSize: [41, 41],
  });

  async function getCCTVData1() {
    let url1 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?%24skip=500&%24format=JSON'; 
    axios.get(url1).then(async (res1) => {
      let data1 = await res1.data;
      console.log(data1.CCTVs);

      for (let j1 = 0; j1 < data1.CCTVs.length; j1++) { 	
        let imgTag1 = `<img src="${data1.CCTVs[j1].VideoStreamURL}" width="380" height="240"/>`;
        L.marker([data1.CCTVs[j1].PositionLat, data1.CCTVs[j1].PositionLon], {
          icon: cctvIcon1, 
          title: 'CCTV1'
        }).bindPopup(
          `路名：${data1.CCTVs[j1].RoadName}</br>${imgTag1}`,
          { maxWidth: "640", maxHeight: "480" }
        ).addTo(highwayCCTVLayer);
      }
    }).catch((error1) => {
      console.log(error1);
    });
  }
  getCCTVData1();

  // 把 CCTV 圖層加到圖層控制器
  const overlayLayers = {
    "台南市 CCTV": cityCCTVLayer,
    "高速公路 CCTV": highwayCCTVLayer
  };
  L.control.layers(basemapLayers, overlayLayers, { position: 'topleft' }).addTo(map);




	

  
	  
	  
	  
  </script>
</body>
</html>
