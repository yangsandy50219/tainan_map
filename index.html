<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>äº¤é€šå„€è¡¨æ¿</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100%;
      width: 100%;
      font-size: 14px;
    }

    .leaflet-control {
      z-index: 2000 !important;
    }

    .mouse-position {
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 14px;
    }


    .legend {
      background: rgba(255, 255, 255, .9);
      padding: 8px 10px;
      border-radius: 8px;
      line-height: 18px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      font-size: 13px;
    }

    .legend .item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .legend img {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    .legend .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #d9534f;
      border: 2px solid #fff;
      box-shadow: 0 0 4px rgba(0, 0, 0, .4);
    }

    .legend .title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .custom-title {
      background: #f8f9fa;
      padding: 4px 8px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // #region token&API
    // ğŸ”‘ æ›æˆä½ è‡ªå·±çš„ AppID èˆ‡ AppKey
    const AppID = "f64114051-51c79fb9-4206-46dc";
    const AppKey = "f20440d9-6d85-4aa5-ab13-5389cb2a6919";

    let token = null;
    let tokenExpireTime = 0;

    // å–å¾—æˆ–æ›´æ–° Token
    async function getToken() {
      const now = Date.now();
      if (token && now < tokenExpireTime) {
        return token;
      }
      try {
        const res = await axios.post(
          "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
          new URLSearchParams({
            grant_type: "client_credentials",
            client_id: AppID,
            client_secret: AppKey
          }),
          { headers: { "Content-Type": "application/x-www-form-urlencoded" } }
        );
        token = res.data.access_token;
        tokenExpireTime = now + (res.data.expires_in - 60) * 1000; // æå‰ 1 åˆ†é˜æ›´æ–°
        return token;
      } catch (err) {
        console.error("âŒ å–å¾— Token å¤±æ•—", err.response?.data || err);
        return null;
      }
    }
    // #endregion

    // #region åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­é¡¯ç¤ºæ•´å€‹å°å—å¸‚
    const map = L.map("map").fitBounds([
      [22.90, 120.10],
      [23.30, 120.55]
    ]);
    // #endregion

    // #region åº•åœ–
    const EMap = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const orthophoto = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });
    const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap & Â© CARTO',
      subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const basemapLayers = {
      "è‡ºç£é€šç”¨é›»å­åœ°åœ–": EMap,
      "æ­£å°„å½±åƒåœ–": orthophoto,
      "OpenStreetMap": osm,
      "ç°¡æ½”åº•åœ–": lightBasemap
    };
    // #endregion
    
    // #region////// æ»‘é¼ ä½ç½®é¡¯ç¤º /////////////
    var mousePositionControl = L.control({ position: 'bottomleft' });
    mousePositionControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'mouse-position');
      div.innerHTML = 'ç¶“ç·¯åº¦: ';
      return div;
    };
    mousePositionControl.addTo(map);

    map.on('mousemove', function (e) {
      var latlng = e.latlng;
      document.querySelector('.mouse-position').innerHTML =
        'ç¶“ç·¯åº¦ï¼š( ' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6) + ' )';
    });
    // #endregion

    // #region////// å›åˆ°å°å—å¸‚éˆ• /////////////
    var infoControl = L.control({ position: 'bottomleft' });
    infoControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = '<b>é»æ“Šæ­¤è™•å›åˆ°å°å—å¸‚</b>';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      div.style.padding = '5px';
      div.style.borderRadius = '5px';
      div.style.fontSize = '16px';
      div.style.fontWeight = 'bold';
      div.style.cursor = 'pointer';
      div.onclick = function () {
        map.fitBounds([
          [22.90, 120.10],
          [23.30, 120.55]
        ]);
      };
      return div;
    };
    infoControl.addTo(map);
    // #endregion

    // #region////// å°å—å¸‚å€ç•Œåœ–å±¤ ///////////
    const districtLayer = L.layerGroup();

    fetch("tn-town.geojson")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: function (feature) {
            // åˆ¤æ–·å±¬æ€§ï¼Œå¤–æ¡† vs å€ç•Œ
            // å‡è¨­ TOWNNAME = "å°å—å¸‚" ä»£è¡¨å¤§å¤–æ¡†ï¼Œå…¶é¤˜æ˜¯å€ç•Œ
            if (feature.properties.TOWNNAME === "å°å—å¸‚") {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 2,          // ç·šæ¢ç²—
                opacity: 1,
                fillOpacity: 0,     // ä¸è¦å¡«æ»¿
                dashArray: null     // å¯¦ç·š
              };
            } else {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 0.7,
                opacity: 0.8,
                fillOpacity: 0,
                dashArray: "5, 5"   // è™›ç·š (5px ç·šæ®µ, 5px é–“éš”)
              };
            }
          },
          onEachFeature: function (feature, layer) {
            if (feature.properties) {
              layer.bindPopup("è¡Œæ”¿å€ï¼š" + (feature.properties.TOWNNAME || "æœªçŸ¥"));
            }
          }
        }).addTo(districtLayer);

        districtLayer.addTo(map); // é è¨­é¡¯ç¤º
        console.log("âœ… å°å—å¸‚å€ç•Œè¼‰å…¥å®Œæˆ");
      })
      .catch(err => console.error("âŒ è¼‰å…¥å€ç•Œå¤±æ•—", err));
      // #endregion


    // #region///////// CCTV /////////////////
    // CCTV åœ–å±¤ï¼ˆé è¨­éƒ½ä¸åŠ åˆ°åœ°åœ–ï¼‰
    const cityCCTVLayer = L.layerGroup();      // å°å—å¸‚
    const highwayCCTVLayer = L.layerGroup();   // åœ‹é“/é«˜é€Ÿ
    const provinceCCTVLayer = L.layerGroup();  // çœé“

    // CCTV ç¸½é–‹é—œï¼šæŠŠä¸‰å€‹å­åœ–å±¤ç´å…¥ä¸€å€‹ LayerGroup
    const allCCTV = L.layerGroup([
      cityCCTVLayer,
      highwayCCTVLayer,
      provinceCCTVLayer
    ]);

    // icon
    var cctvIcon = new L.Icon({ iconUrl: 'https://i.postimg.cc/XvSCdW0M/CCTV.png', iconSize: [30, 30] }); // å¸‚å€
    var cctvIcon1 = new L.Icon({ iconUrl: 'https://i.postimg.cc/4y0yH2L2/CCTV.png', iconSize: [30, 30] });                       // é«˜é€Ÿ
    var cctvIcon2 = new L.Icon({ iconUrl: 'https://i.postimg.cc/mgPPHCGP/CCTV.png', iconSize: [30, 30] });                       // çœé“

    // å°å—å¸‚ CCTV
    async function getCCTVData() {
      const token = await getToken();
      if (!token) return;

      axios.get("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Tainan?$format=JSON", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(res => {
        (res.data.CCTVs || []).forEach(c => {
          let imgTag = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
          L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon })
            .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag}`, { maxWidth: "640", maxHeight: "480" })
            .addTo(cityCCTVLayer);
        });
      }).catch(err => console.error("âŒ å¸‚å€ CCTV è®€å–å¤±æ•—", err));
    }

    // é«˜é€Ÿå…¬è·¯ CCTVï¼ˆç¯©é¸å°å—å¸‚ï¼‰
    async function getCCTVData1() {
      const token = await getToken();
      if (!token) return;

      let url1 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
      axios.get(url1, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(async (res1) => {
          let data1 = await res1.data;
          console.log("ğŸš¦ Freeway API å›å‚³å…§å®¹ï¼š", data1);

          const cctvs = data1.CCTVs || data1.FreewayCCTVs || [];
          console.log("é«˜é€Ÿå…¬è·¯ CCTV åŸå§‹æ•¸é‡ï¼š", cctvs.length);

          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.90 && c.PositionLat <= 23.30 &&
            c.PositionLon >= 120.10 && c.PositionLon <= 120.55
          );

          console.log("å°å—å¸‚å…§çš„é«˜é€Ÿå…¬è·¯ CCTV æ•¸é‡ï¼š", filtered.length);

          filtered.forEach(c => {
            let imgTag1 = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon1 })
              .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag1}`, { maxWidth: "640", maxHeight: "480" })
              .addTo(highwayCCTVLayer);
          });
        })
        .catch((error1) => {
          console.error("âŒ é«˜é€Ÿå…¬è·¯ CCTV è®€å–å¤±æ•—", error1);
        });
    }

    // çœé“ CCTV
    async function getCCTVData2() {
      const token = await getToken();
      if (!token) return;

      let url2 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?$format=JSON';
      axios.get(url2, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(async (res2) => {
          let data2 = await res2.data;
          console.log("ğŸš¦ Highway API å›å‚³å…§å®¹ï¼š", data2);

          const cctvs = data2.CCTVs || [];
          console.log("çœé“ CCTV åŸå§‹æ•¸é‡ï¼š", cctvs.length);

          // ç¯©é¸å°å—å¸‚ç¯„åœ
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.90 && c.PositionLat <= 23.30 &&
            c.PositionLon >= 120.10 && c.PositionLon <= 120.55
          );

          console.log("å°å—å¸‚å…§çš„çœé“ CCTV æ•¸é‡ï¼š", filtered.length);

          filtered.forEach(c => {
            let imgTag2 = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon2 })
              .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag2}`, { maxWidth: "640", maxHeight: "480" })
              .addTo(provinceCCTVLayer);
          });

          console.log("âœ… provinceCCTVLayer ç¸½æ•¸ï¼š", provinceCCTVLayer.getLayers().length);
        })
        .catch((error2) => {
          console.error("âŒ çœé“ CCTV è®€å–å¤±æ•—", error2);
        });
    }
    // #endregion


    // #region////// å³æ™‚é“è·¯äº‹ä»¶ /////////////
    // å»ºç«‹ä¸‰å€‹å­åœ–å±¤
    const cityEventsLayer = L.layerGroup();
    const freewayEventsLayer = L.layerGroup();
    const highwayEventsLayer = L.layerGroup();

    // åˆä½µæˆä¸€å€‹ç¸½åœ–å±¤
    const allEventsLayer = L.layerGroup([
      cityEventsLayer,
      freewayEventsLayer,
      highwayEventsLayer
    ]);

    // WKT è§£æ
    function parseWKTPoint(wkt) {
      if (!wkt || !wkt.startsWith("POINT")) return null;
      const nums = wkt.replace(/POINT\s*\(|\)/g, "").trim().split(/\s+/).map(Number);
      if (nums.length !== 2 || nums.some(isNaN)) return null;
      const [lon, lat] = nums;
      return [lat, lon]; // Leaflet æ ¼å¼
    }

    // é™åˆ¶ç¯„åœ (å°å—å¸‚å¤§æ¦‚ç¯„åœ)
    function isInTainan(lat, lon) {
      return lat >= 22.887 && lat <= 23.413 &&
        lon >= 120.007 && lon <= 120.627;
    }

    // é¸ icon
    function getEventIcon(desc) {
      let url;
      if (desc && desc.includes("è»Šç¦")) {
        url = "https://i.postimg.cc/KvcjXzmv/image.png";
      } else if (desc && desc.includes("æ–½å·¥")) {
        url = "https://i.postimg.cc/fTHLMNb7/image.png";
      } else if (desc && desc.includes("ç½å®³")) {
        url = "https://i.postimg.cc/0NS2GK0Z/image.png";
      }
      if (url) {
        return L.icon({ iconUrl: url, iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
      } else {
        return L.divIcon({
          className: 'live-event-icon',
          html: '<div style="width:14px;height:14px;border-radius:50%;background:#d9534f;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,.4)"></div>',
          iconSize: [14, 14], iconAnchor: [7, 7]
        });
      }
    }

    // å…±ç”¨çš„äº‹ä»¶è¼‰å…¥ function
    async function loadEvents(url, targetLayer) {
      const token = await getToken();
      if (!token) return;

      try {
        const { data } = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        targetLayer.clearLayers();

        const events = data?.LiveEvents || [];
        events.forEach(ev => {
          const latlng = parseWKTPoint(ev.Positions);
          if (!latlng) return;
          if (!isInTainan(latlng[0], latlng[1])) return; // é™åˆ¶å°å—ç¯„åœ

          const popupHtml = `
        <div style="min-width:220px">
          <div style="font-weight:700;margin-bottom:4px">${ev.EventTitle || "é“è·¯äº‹ä»¶"}</div>
          ${ev.Description ? `<div>å…§å®¹ï¼š${ev.Description}</div>` : ""}
          ${ev?.Location?.Other ? `<div>åœ°é»ï¼š${ev.Location.Other}</div>` : ""}
          ${ev.Source ? `<div>ä¾†æºï¼š${ev.Source}</div>` : ""}
        </div>
      `;
          L.marker(latlng, { icon: getEventIcon(ev.Description) })
            .bindPopup(popupHtml)
            .addTo(targetLayer);
        });

        // è¨­å®šè‡ªå‹•åˆ·æ–°
        const intervalSec = Number(data?.UpdateInterval) || 60;
        setTimeout(() => loadEvents(url, targetLayer), intervalSec * 1000);

      } catch (err) {
        console.error("âŒ é“è·¯äº‹ä»¶è®€å–å¤±æ•—", url, err);
        setTimeout(() => loadEvents(url, targetLayer), 60000);
      }
    }

    // å•Ÿå‹•ä¸‰å€‹ä¾†æº
    function loadAllEvents() {
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/City/Tainan?$format=JSON", cityEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Freeway?$format=JSON", freewayEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Highway?$format=JSON", highwayEventsLayer);
    }
    // #endregion









    // #region/////////åœ–å±¤æ§åˆ¶å™¨//////////////
    // === åº•åœ–æ§åˆ¶å™¨ ===
    L.control.layers(basemapLayers, null, { position: 'topleft', collapsed: false }).addTo(map);

    // === CCTV æ§åˆ¶å™¨ï¼ˆè¡Œäººå°ˆç”¨ï¼‰===
    const cctvControl = L.control.layers(null, { "CCTV": allCCTV }, { position: 'topleft', collapsed: true });
    cctvControl.addTo(map);

    // === é“è·¯äº‹ä»¶æ§åˆ¶å™¨ï¼ˆé§•é§›äººå°ˆç”¨ï¼‰===
    const eventControl = L.control.layers(null, { "å³æ™‚é“è·¯äº‹ä»¶": allEventsLayer }, { position: 'topleft', collapsed: true });
    eventControl.addTo(map);

    // === ä¿®æ”¹æ¨™é¡Œ ===
    setTimeout(() => {
      // æ‰¾åˆ° Leaflet æ§åˆ¶å™¨çš„ DOM
      const controls = document.querySelectorAll('.leaflet-control-layers');
      if (controls.length >= 3) {
        controls[1].querySelector('.leaflet-control-layers-toggle').title = "è¡Œäººå°ˆç”¨";
        controls[1].insertAdjacentHTML("afterbegin", "<div class='custom-title'>è¡Œäººå°ˆç”¨</div>");

        controls[2].querySelector('.leaflet-control-layers-toggle').title = "é§•é§›äººå°ˆç”¨";
        controls[2].insertAdjacentHTML("afterbegin", "<div class='custom-title'>é§•é§›äººå°ˆç”¨</div>");
      }
    }, 100);

    // åŸ·è¡Œ
    getCCTVData();
    getCCTVData1();
    getCCTVData2();
    loadAllEvents();
    // #endregion


    // #region///////// åœ–ä¾‹ /////////////////
    // CCTV åœ–ä¾‹ï¼ˆå¸‚å€/é«˜é€Ÿ/çœé“ï¼‰
    const cctvLegend = L.control({ position: 'bottomright' });
    cctvLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">CCTV åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/XvSCdW0M/CCTV.png" alt="å¸‚å€ CCTV"> <span>å¸‚å€ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/4y0yH2L2/CCTV.png" alt="åœ‹é“/é«˜é€Ÿ CCTV"> <span>åœ‹é“/é«˜é€Ÿ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/mgPPHCGP/CCTV.png" alt="çœé“ CCTV"> <span>çœé“ CCTV</span></div>
  `;
      return div;
    };

    // åªåœ¨ã€ŒCCTVï¼ˆå…¨éƒ¨ï¼‰ã€æ‰“é–‹æ™‚é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "CCTV") {
        cctvLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "CCTV") {
        map.removeControl(cctvLegend);
      }
    });


    // å³æ™‚é“è·¯äº‹ä»¶åœ–ä¾‹
    // å»ºç«‹åœ–ä¾‹ï¼ˆä½†å…ˆä¸è¦åŠ åˆ° mapï¼‰
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">äº‹ä»¶åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/KvcjXzmv/image.png" alt="è»Šç¦"> <span>è»Šç¦</span></div>
    <div class="item"><img src="https://i.postimg.cc/fTHLMNb7/image.png" alt="æ–½å·¥"> <span>æ–½å·¥</span></div>
    <div class="item"><img src="https://i.postimg.cc/0NS2GK0Z/image.png" alt="ç½å®³"> <span>ç½å®³</span></div>
    <div class="item"><span class="dot"></span> <span>å…¶ä»–äº‹ä»¶</span></div>
  `;
      return div;
    };

    // ç•¶ä½¿ç”¨è€…ã€Œæ‰“é–‹ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        legend.addTo(map);
      }
    });

    // ç•¶ä½¿ç”¨è€…ã€Œé—œé–‰ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ ç§»é™¤åœ–ä¾‹
    map.on("overlayremove", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        map.removeControl(legend);
      }
    });
    // #endregion



  </script>


</body>

</html>
