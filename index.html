<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>äº¤é€šå„€è¡¨æ¿</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100%;
      width: 100%;
      font-size: 14px;
    }

    .leaflet-control {
      z-index: 2000 !important;
    }

    .mouse-position {
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // ğŸ”‘ æ›æˆä½ è‡ªå·±çš„ AppID èˆ‡ AppKey
    const AppID = "f64114051-51c79fb9-4206-46dc";
    const AppKey = "f20440d9-6d85-4aa5-ab13-5389cb2a6919";

    let token = null;
    let tokenExpireTime = 0;

    // å–å¾—æˆ–æ›´æ–° Token
    async function getToken() {
      const now = Date.now();
      if (token && now < tokenExpireTime) {
        return token;
      }
      try {
        const res = await axios.post(
          "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
          new URLSearchParams({
            grant_type: "client_credentials",
            client_id: AppID,
            client_secret: AppKey
          }),
          { headers: { "Content-Type": "application/x-www-form-urlencoded" } }
        );
        token = res.data.access_token;
        tokenExpireTime = now + (res.data.expires_in - 60) * 1000; // æå‰ 1 åˆ†é˜æ›´æ–°
        return token;
      } catch (err) {
        console.error("âŒ å–å¾— Token å¤±æ•—", err.response?.data || err);
        return null;
      }
    }

    // åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­é¡¯ç¤ºæ•´å€‹å°å—å¸‚
    const map = L.map("map").fitBounds([
      [22.887, 120.007],
      [23.413, 120.627]
    ]);

    // åº•åœ–
    const EMap = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const orthophoto = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });
    const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap & Â© CARTO',
      subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const basemapLayers = {
      "è‡ºç£é€šç”¨é›»å­åœ°åœ–": EMap,
      "æ­£å°„å½±åƒåœ–": orthophoto,
      "OpenStreetMap": osm,
      "ç°¡æ½”åº•åœ–": lightBasemap
    };

    ////// æ»‘é¼ ä½ç½®é¡¯ç¤º ///////
    var mousePositionControl = L.control({ position: 'bottomleft' });
    mousePositionControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'mouse-position');
      div.innerHTML = 'ç¶“ç·¯åº¦: ';
      return div;
    };
    mousePositionControl.addTo(map);

    map.on('mousemove', function (e) {
      var latlng = e.latlng;
      document.querySelector('.mouse-position').innerHTML =
        'ç¶“ç·¯åº¦ï¼š( ' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6) + ' )';
    });

    ////// å›åˆ°å°å—å¸‚ ///////
    var infoControl = L.control({ position: 'bottomleft' });
    infoControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = '<b>é»æ“Šæ­¤è™•å›åˆ°å°å—å¸‚</b>';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      div.style.padding = '5px';
      div.style.borderRadius = '5px';
      div.style.fontSize = '16px';
      div.style.fontWeight = 'bold';
      div.style.cursor = 'pointer';
      div.onclick = function () {
        map.fitBounds([
          [22.887, 120.007],
          [23.413, 120.627]
        ]);
      };
      return div;
    };
    infoControl.addTo(map);

    /////////////////// ä»‹æ¥ TDX CCTV ///////////////////////
    const cityCCTVLayer = L.layerGroup().addTo(map);
    const highwayCCTVLayer = L.layerGroup();
    const provinceCCTVLayer = L.layerGroup();

    var cctvIcon = new L.Icon({ iconUrl: 'https://i.postimg.cc/wjz66NjK/CCTV.png', iconSize: [41, 41] });
    var cctvIcon1 = new L.Icon({ iconUrl: 'https://i.postimg.cc/4y0yH2L2/CCTV.png', iconSize: [41, 41] });
    var cctvIcon2 = new L.Icon({ iconUrl: 'https://i.postimg.cc/mgPPHCGP/CCTV.png', iconSize: [41, 41] });

    // å°å—å¸‚ CCTV
    async function getCCTVData() {
      const token = await getToken();
      if (!token) return;

      axios.get("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Tainan?$format=JSON", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(res => {
        (res.data.CCTVs || []).forEach(c => {
          let imgTag = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
          L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon })
            .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag}`, { maxWidth: "640", maxHeight: "480" })
            .addTo(cityCCTVLayer);
        });
      }).catch(err => console.error("âŒ å¸‚å€ CCTV è®€å–å¤±æ•—", err));
    }

    // é«˜é€Ÿå…¬è·¯ CCTVï¼ˆç¯©é¸å°å—å¸‚ï¼‰
    async function getCCTVData1() {
      const token = await getToken();
      if (!token) return;

      let url1 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
      axios.get(url1, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(async (res1) => {
          let data1 = await res1.data;
          console.log("ğŸš¦ Freeway API å›å‚³å…§å®¹ï¼š", data1);

          const cctvs = data1.CCTVs || data1.FreewayCCTVs || [];
          console.log("é«˜é€Ÿå…¬è·¯ CCTV åŸå§‹æ•¸é‡ï¼š", cctvs.length);

          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          console.log("å°å—å¸‚å…§çš„é«˜é€Ÿå…¬è·¯ CCTV æ•¸é‡ï¼š", filtered.length);

          filtered.forEach(c => {
            let imgTag1 = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon1 })
              .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag1}`, { maxWidth: "640", maxHeight: "480" })
              .addTo(highwayCCTVLayer);
          });
        })
        .catch((error1) => {
          console.error("âŒ é«˜é€Ÿå…¬è·¯ CCTV è®€å–å¤±æ•—", error1);
        });
    }

    // çœé“ CCTV
    async function getCCTVData2() {
      const token = await getToken();
      if (!token) return;

      let url2 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?$format=JSON';
      axios.get(url2, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(async (res2) => {
          let data2 = await res2.data;
          console.log("ğŸš¦ Highway API å›å‚³å…§å®¹ï¼š", data2);

          const cctvs = data2.CCTVs || [];
          console.log("çœé“ CCTV åŸå§‹æ•¸é‡ï¼š", cctvs.length);

          // ç¯©é¸å°å—å¸‚ç¯„åœ
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          console.log("å°å—å¸‚å…§çš„çœé“ CCTV æ•¸é‡ï¼š", filtered.length);

          filtered.forEach(c => {
            let imgTag2 = `<img src="${c.VideoStreamURL}" width="380" height="240"/>`;
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon2 })
              .bindPopup(`è·¯åï¼š${c.RoadName}</br>${imgTag2}`, { maxWidth: "640", maxHeight: "480" })
              .addTo(provinceCCTVLayer);
          });

          console.log("âœ… provinceCCTVLayer ç¸½æ•¸ï¼š", provinceCCTVLayer.getLayers().length);
        })
        .catch((error2) => {
          console.error("âŒ çœé“ CCTV è®€å–å¤±æ•—", error2);
        });
    }


    // æŠŠ CCTV åœ–å±¤åŠ åˆ°åœ–å±¤æ§åˆ¶å™¨
    const overlayLayers = {
      "å°å—å¸‚ CCTV": cityCCTVLayer,
      "é«˜é€Ÿå…¬è·¯ CCTV": highwayCCTVLayer,
      "çœé“ CCTV": provinceCCTVLayer
    };
    L.control.layers(basemapLayers, overlayLayers, { position: 'topleft' }).addTo(map);

    // åŸ·è¡Œ
    getCCTVData();
    getCCTVData1();
    getCCTVData2();
  </script>


</body>

</html>