<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>äº¤é€šå„€è¡¨æ¿</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- Leaflet PIP (Point in Polygon) -->
  <script src="https://unpkg.com/leaflet-pip/leaflet-pip.min.js"></script>
  <script src="https://unpkg.com/wellknown/wellknown.js"></script>

  <!--marker clustering (ç¾¤é›†)å¥—ä»¶-->>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100%;
      width: 100%;
      font-size: 14px;
    }

    .leaflet-control {
      z-index: 2000 !important;
    }

    .mouse-position {
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 14px;
    }


    .legend {
      background: rgba(255, 255, 255, .9);
      padding: 8px 10px;
      border-radius: 8px;
      line-height: 18px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      font-size: 13px;
    }

    .legend .item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .legend img {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    .legend .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #d9534f;
      border: 2px solid #fff;
      box-shadow: 0 0 4px rgba(0, 0, 0, .4);
    }

    .legend .title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .custom-title {
      background: #f8f9fa;
      padding: 4px 8px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // #region token&API
    // ç¬¬ä¸€çµ„ (å°ˆé–€çµ¦ CCTVã€é“è·¯äº‹ä»¶ç”¨)
    const AppID1 = "f64114051-51c79fb9-4206-46dc";
    const AppKey1 = "f20440d9-6d85-4aa5-ab13-5389cb2a6919";

    // ç¬¬äºŒçµ„ (å°ˆé–€çµ¦ å…¬è»Šã€è‡ªè¡Œè»Šé“ã€YouBike ç”¨)
    const AppID2 = "f64114051-924181ba-6a4d-4890";
    const AppKey2 = "043fcebb-22e0-4b48-a45a-79e5fdbe2b9f";

    let token1 = null, tokenExpireTime1 = 0;
    let token2 = null, tokenExpireTime2 = 0;

    // å…±ç”¨çš„ getTokenï¼Œä¾ä¾†æºé¸å“ªçµ„
    async function getToken(which = 1) {
      const now = Date.now();

      if (which === 1 && token1 && now < tokenExpireTime1) return token1;
      if (which === 2 && token2 && now < tokenExpireTime2) return token2;

      try {
        const res = await axios.post(
          "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
          new URLSearchParams({
            grant_type: "client_credentials",
            client_id: which === 1 ? AppID1 : AppID2,
            client_secret: which === 1 ? AppKey1 : AppKey2
          }),
          { headers: { "Content-Type": "application/x-www-form-urlencoded" } }
        );

        const tk = res.data.access_token;
        const exp = now + (res.data.expires_in - 60) * 1000;

        if (which === 1) {
          token1 = tk;
          tokenExpireTime1 = exp;
        } else {
          token2 = tk;
          tokenExpireTime2 = exp;
        }

        return tk;
      } catch (err) {
        console.error("âŒ å–å¾— Token å¤±æ•—", err.response?.data || err);
        return null;
      }
    }

    // #endregion

    // #region åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­é¡¯ç¤ºæ•´å€‹å°å—å¸‚
    const map = L.map("map").fitBounds([
      [22.90, 120.10],
      [23.30, 120.55]
    ]);
    // #endregion

    // #region åº•åœ–
    const EMap = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const orthophoto = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });
    const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap & Â© CARTO',
      subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const basemapLayers = {
      "é è¨­åº•åœ–": lightBasemap,
      "è‡ºç£é€šç”¨é›»å­åœ°åœ–": EMap,
      "æ­£å°„å½±åƒåœ–": orthophoto,
      "OpenStreetMap": osm
    };
    // #endregion

    // #region////// æ»‘é¼ ä½ç½®é¡¯ç¤º /////////////
    var mousePositionControl = L.control({ position: 'bottomleft' });
    mousePositionControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'mouse-position');
      div.innerHTML = 'ç¶“ç·¯åº¦: ';
      return div;
    };
    mousePositionControl.addTo(map);

    map.on('mousemove', function (e) {
      var latlng = e.latlng;
      document.querySelector('.mouse-position').innerHTML =
        'ç¶“ç·¯åº¦ï¼š( ' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6) + ' )';
    });
    // #endregion

    // #region////// å›åˆ°å°å—å¸‚éˆ• /////////////
    var infoControl = L.control({ position: 'bottomleft' });
    infoControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = '<b>é»æ“Šæ­¤è™•å›åˆ°å°å—å¸‚</b>';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      div.style.padding = '5px';
      div.style.borderRadius = '5px';
      div.style.fontSize = '16px';
      div.style.fontWeight = 'bold';
      div.style.cursor = 'pointer';
      div.onclick = function () {
        map.fitBounds([
          [22.90, 120.10],
          [23.30, 120.55]
        ]);
      };
      return div;
    };
    infoControl.addTo(map);
    // #endregion

    // #region ////// å°å—å¸‚å€ç•Œåœ–å±¤ ////// 
    let districtLayer; // å­˜ GeoJSON layer

    fetch("tn-town.geojson")
      .then(res => res.json())
      .then(data => {
        districtLayer = L.geoJSON(data, {
          style: function (feature) {
            if (feature.properties.TOWN === "å°å—å¸‚") {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 2,          // ç·šæ¢ç²—
                opacity: 1,
                fillOpacity: 0,     // ä¸è¦å¡«æ»¿
                dashArray: null     // å¯¦ç·š
              };
            } else {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 0.7,
                opacity: 0.8,
                fillOpacity: 0,
                dashArray: "5, 5"   // è™›ç·š (5px ç·šæ®µ, 5px é–“éš”)
              };
            }
          },
          onEachFeature: function (feature, layer) {
            if (feature.properties) {
              // âš¡ ç›´æ¥é» polygon æ™‚æ‰æœƒé¡¯ç¤º popup
              layer.bindPopup("è¡Œæ”¿å€ï¼š" + (feature.properties.TOWN || "æœªçŸ¥"));
            }
          }
        }).addTo(map);

        console.log("âœ… å°å—å¸‚å€ç•Œè¼‰å…¥å®Œæˆ");
      })
      .catch(err => console.error("âŒ è¼‰å…¥å€ç•Œå¤±æ•—", err));
    // #endregion


    // #region///////// CCTV /////////////////
    // CCTV åœ–å±¤ï¼ˆé è¨­éƒ½ä¸åŠ åˆ°åœ°åœ–ï¼‰
    const cityCCTVLayer = L.layerGroup();      // å°å—å¸‚
    const highwayCCTVLayer = L.layerGroup();   // åœ‹é“/é«˜é€Ÿ
    const provinceCCTVLayer = L.layerGroup();  // çœé“

    // CCTV ç¸½é–‹é—œï¼šæŠŠä¸‰å€‹å­åœ–å±¤ç´å…¥ä¸€å€‹ LayerGroup
    const allCCTV = L.layerGroup([
      cityCCTVLayer,
      highwayCCTVLayer,
      provinceCCTVLayer
    ]);

    // icon
    var cctvIcon = new L.Icon({ iconUrl: 'https://i.postimg.cc/XvSCdW0M/CCTV.png', iconSize: [30, 30] }); // å¸‚å€
    var cctvIcon1 = new L.Icon({ iconUrl: 'https://i.postimg.cc/4y0yH2L2/CCTV.png', iconSize: [30, 30] });                       // é«˜é€Ÿ
    var cctvIcon2 = new L.Icon({ iconUrl: 'https://i.postimg.cc/mgPPHCGP/CCTV.png', iconSize: [30, 30] });                       // çœé“

    // ğŸ“Œ å…±ç”¨ï¼šå»ºç«‹ CCTV popup (æœƒå‹•æ…‹æ›´æ–°æ™‚é–“)
    function createCCTVPopup(roadName, videoUrl) {
      const popupId = "popup-" + Math.random().toString(36).substr(2, 9);

      const html = `
    <div style="min-width:380px;">
      <div id="${popupId}" style="text-align:right;font-size:12px;color:#666;margin-bottom:2px;">
        æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString()}
      </div>
      <img src="${videoUrl}" width="380" height="240" style="display:block;"/>
    </div>
  `;

      // æ¯ç§’æ›´æ–° popup è£¡çš„æ™‚é–“
      setInterval(() => {
        const el = document.getElementById(popupId);
        if (el) {
          el.innerText = new Date().toLocaleString();
        }
      }, 1000);

      return `è·¯åï¼š${roadName}</br>${html}`;
    }

    // å¸‚å€ CCTV //
    async function getCCTVData() {
      const token = await getToken(1);
      if (!token) return;

      axios.get("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Tainan?$format=JSON", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(res => {
        (res.data.CCTVs || []).forEach(c => {
          L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon })
            .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
            .addTo(cityCCTVLayer);
        });
      }).catch(err => console.error("âŒ å¸‚å€ CCTV è®€å–å¤±æ•—", err));
    }

    // é«˜é€Ÿå…¬è·¯ CCTV //
    async function getCCTVData1() {
      const token = await getToken(1);
      if (!token) return;

      let url1 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
      axios.get(url1, { headers: { Authorization: `Bearer ${token}` } })
        .then(res1 => {
          const cctvs = res1.data.CCTVs || res1.data.FreewayCCTVs || [];
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          filtered.forEach(c => {
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon1 })
              .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
              .addTo(highwayCCTVLayer);
          });
        })
        .catch(err => console.error("âŒ é«˜é€Ÿå…¬è·¯ CCTV è®€å–å¤±æ•—", err));
    }

    // çœé“ CCTV //
    async function getCCTVData2() {
      const token = await getToken(1);
      if (!token) return;

      let url2 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?$format=JSON';
      axios.get(url2, { headers: { Authorization: `Bearer ${token}` } })
        .then(res2 => {
          const cctvs = res2.data.CCTVs || [];
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          filtered.forEach(c => {
            L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon2 })
              .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
              .addTo(provinceCCTVLayer);
          });
        })
        .catch(err => console.error("âŒ çœé“ CCTV è®€å–å¤±æ•—", err));
    }


    // CCTV åœ–ä¾‹ï¼ˆå¸‚å€/é«˜é€Ÿ/çœé“ï¼‰
    const cctvLegend = L.control({ position: 'bottomright' });
    cctvLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">CCTV åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/XvSCdW0M/CCTV.png" alt="å¸‚å€ CCTV"> <span>å¸‚å€ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/4y0yH2L2/CCTV.png" alt="åœ‹é“/é«˜é€Ÿ CCTV"> <span>åœ‹é“/é«˜é€Ÿ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/mgPPHCGP/CCTV.png" alt="çœé“ CCTV"> <span>çœé“ CCTV</span></div>
  `;
      return div;
    };
    // åªåœ¨ã€ŒCCTVï¼ˆå…¨éƒ¨ï¼‰ã€æ‰“é–‹æ™‚é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "CCTV") {
        cctvLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "CCTV") {
        map.removeControl(cctvLegend);
      }
    });


    // #endregion


    // #region////// å³æ™‚é“è·¯äº‹ä»¶ /////////////
    // å»ºç«‹ä¸‰å€‹å­åœ–å±¤
    const cityEventsLayer = L.layerGroup();
    const freewayEventsLayer = L.layerGroup();
    const highwayEventsLayer = L.layerGroup();

    // åˆä½µæˆä¸€å€‹ç¸½åœ–å±¤
    const allEventsLayer = L.layerGroup([
      cityEventsLayer,
      freewayEventsLayer,
      highwayEventsLayer
    ]);

    // WKT è§£æ
    function parseWKTPoint(wkt) {
      if (!wkt || !wkt.startsWith("POINT")) return null;
      const nums = wkt.replace(/POINT\s*\(|\)/g, "").trim().split(/\s+/).map(Number);
      if (nums.length !== 2 || nums.some(isNaN)) return null;
      const [lon, lat] = nums;
      return [lat, lon]; // Leaflet æ ¼å¼
    }

    // æ™‚é–“æ ¼å¼å°å·¥å…·
    function fmtTime(iso) {
      try {
        return new Date(iso).toLocaleString();
      } catch {
        return iso || "";
      }
    }

    // é™åˆ¶ç¯„åœ (å°å—å¸‚å¤§æ¦‚ç¯„åœ)
    function isInTainan(lat, lon) {
      return lat >= 22.887 && lat <= 23.413 &&
        lon >= 120.007 && lon <= 120.627;
    }

    // é¸ icon
    function getEventIcon(desc) {
      let url;
      if (desc && desc.includes("è»Šç¦")) {
        url = "https://i.postimg.cc/KvcjXzmv/image.png";
      } else if (desc && desc.includes("æ–½å·¥")) {
        url = "https://i.postimg.cc/fTHLMNb7/image.png";
      } else if (desc && desc.includes("ç½å®³")) {
        url = "https://i.postimg.cc/0NS2GK0Z/image.png";
      }
      if (url) {
        return L.icon({ iconUrl: url, iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
      } else {
        return L.divIcon({
          className: 'live-event-icon',
          html: '<div style="width:14px;height:14px;border-radius:50%;background:#d9534f;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,.4)"></div>',
          iconSize: [14, 14], iconAnchor: [7, 7]
        });
      }
    }

    // å…±ç”¨çš„äº‹ä»¶è¼‰å…¥ function
    async function loadEvents(url, targetLayer) {
      const token = await getToken(1);
      if (!token) return;

      try {
        const { data } = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        targetLayer.clearLayers();

        const events = data?.LiveEvents || [];
        events.forEach(ev => {
          const latlng = parseWKTPoint(ev.Positions);
          if (!latlng) return;
          if (!isInTainan(latlng[0], latlng[1])) return; // é™åˆ¶å°å—ç¯„åœ

          const popupHtml = `
        <div style="min-width:220px">
          <div style="font-weight:700;margin-bottom:4px">${ev.EventTitle || "é“è·¯äº‹ä»¶"}</div>
          ${ev.Description ? `<div>å…§å®¹ï¼š${ev.Description}</div>` : ""}
          ${ev?.Location?.Other ? `<div>åœ°é»ï¼š${ev.Location.Other}</div>` : ""}
          ${ev.Source ? `<div>ä¾†æºï¼š${ev.Source}</div>` : ""}
          ${ev.PublishTime ? `<div style="color:#666;font-size:12px">ç™¼å¸ƒæ™‚é–“ï¼š${fmtTime(ev.PublishTime)}</div>` : ""}
          ${ev.LastUpdateTime ? `<div style="color:#666;font-size:12px">æ›´æ–°æ™‚é–“ï¼š${fmtTime(ev.LastUpdateTime)}</div>` : ""}

        </div>
      `;
          L.marker(latlng, { icon: getEventIcon(ev.Description) })
            .bindPopup(popupHtml)
            .addTo(targetLayer);
        });

        // è¨­å®šè‡ªå‹•åˆ·æ–°
        const intervalSec = Number(data?.UpdateInterval) || 60;
        setTimeout(() => loadEvents(url, targetLayer), intervalSec * 1000);

      } catch (err) {
        console.error("âŒ é“è·¯äº‹ä»¶è®€å–å¤±æ•—", url, err);
        setTimeout(() => loadEvents(url, targetLayer), 300000); //äº”åˆ†é˜æ›´æ–°
      }
    }

    // å•Ÿå‹•ä¸‰å€‹ä¾†æº
    function loadAllEvents() {
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/City/Tainan?$format=JSON", cityEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Freeway?$format=JSON", freewayEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Highway?$format=JSON", highwayEventsLayer);
    }


    // å³æ™‚é“è·¯äº‹ä»¶åœ–ä¾‹
    // å»ºç«‹åœ–ä¾‹ï¼ˆä½†å…ˆä¸è¦åŠ åˆ° mapï¼‰
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">äº‹ä»¶åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/KvcjXzmv/image.png" alt="è»Šç¦"> <span>è»Šç¦</span></div>
    <div class="item"><img src="https://i.postimg.cc/fTHLMNb7/image.png" alt="æ–½å·¥"> <span>æ–½å·¥</span></div>
    <div class="item"><img src="https://i.postimg.cc/0NS2GK0Z/image.png" alt="ç½å®³"> <span>ç½å®³</span></div>
    <div class="item"><span class="dot"></span> <span>å…¶ä»–äº‹ä»¶</span></div>
  `;
      return div;
    };
    // ç•¶ä½¿ç”¨è€…ã€Œæ‰“é–‹ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        legend.addTo(map);
      }
    });
    // ç•¶ä½¿ç”¨è€…ã€Œé—œé–‰ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ ç§»é™¤åœ–ä¾‹
    map.on("overlayremove", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        map.removeControl(legend);
      }
    });
    // #endregion


    // #region ////// å°å—å¸‚ å…¬å…±è‡ªè¡Œè»Š ////////
    // (1) è‡ªè¡Œè»Šé“
    const bikeLaneLayer = L.layerGroup();

    async function loadBikeLane() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/V3/Map/Bike/Network/CityBike/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        bikeLaneLayer.clearLayers();

        res.data.forEach(item => {
          if (item.Geometry) {
            try {
              const geojson = wellknown(item.Geometry); // æŠŠ WKT è½‰æˆ GeoJSON
              L.geoJSON(geojson, {
                style: { color: "#0077cc", weight: 2, opacity: 0.9 }
              }).addTo(bikeLaneLayer);
            } catch (e) {
              console.warn("âš ï¸ WKT è§£æå¤±æ•—", item.Geometry);
            }
          }
        });

        console.log("âœ… è‡ªè¡Œè»Šé“è¼‰å…¥å®Œæˆï¼Œç­†æ•¸ï¼š", res.data.length);
      } catch (err) {
        console.error("âŒ è‡ªè¡Œè»Šé“è®€å–å¤±æ•—", err);
      }
    }

    // (2) å…¬å…±è‡ªè¡Œè»Š (YouBike)
    const youbikeLayer = L.layerGroup();
    const youbikeCluster = L.markerClusterGroup();
    youbikeLayer.addLayer(youbikeCluster);

    const youbikeIcon = L.icon({
      iconUrl: "https://i.postimg.cc/260kqMc4/image.png", // ç«™é» icon
      iconSize: [45, 45],
      iconAnchor: [14, 28],
      popupAnchor: [0, -28]
    });

    // æš«å­˜ marker (ç”¨ StationUID å°æ‡‰)
    let youbikeMarkers = new Map();

    async function loadYoubikeStations() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const stations = res.data || [];
        console.log("ğŸš² YouBike ç«™é»æ•¸é‡ï¼š", stations.length);

        youbikeCluster.clearLayers();
        youbikeMarkers.clear();

        stations.forEach(st => {
          const lat = st.StationPosition?.PositionLat;
          const lon = st.StationPosition?.PositionLon;
          if (!lat || !lon) return;

          const name = st.StationName?.Zh_tw || "æœªçŸ¥ç«™é»";

          const marker = L.marker([lat, lon], { icon: youbikeIcon })
            .bindPopup(`<b>${name}</b><br/>è¼‰å…¥ä¸­...`);

          marker._stationUID = st.StationUID;

          youbikeCluster.addLayer(marker);
          youbikeMarkers.set(st.StationUID, marker);
        });

      } catch (err) {
        console.error("âŒ YouBike ç«™é»è®€å–å¤±æ•—", err);
      }
    }

    async function updateYoubikeAvailability() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const avail = res.data || [];

        avail.forEach(item => {
          const marker = youbikeMarkers.get(item.StationUID);
          if (!marker) return;

          const name = marker.getPopup().getContent().split("<br/>")[0];
          marker.bindPopup(`
        ${name}<br/>
        å¯ç§Ÿå€Ÿï¼š${item.AvailableRentBikes}<br/>
        å¯æ­¸é‚„ï¼š${item.AvailableReturnBikes}<br/>
        æ›´æ–°æ™‚é–“ï¼š${new Date(item.UpdateTime).toLocaleTimeString()}
      `);
        });

        // æ¯ 90 ç§’æ›´æ–°ä¸€æ¬¡
        setTimeout(updateYoubikeAvailability, 90000);

      } catch (err) {
        console.error("âŒ YouBike è»Šä½æ›´æ–°å¤±æ•—", err);
        setTimeout(updateYoubikeAvailability, 120000);
      }
    }

    // (3) åˆä½µæˆã€Œè‡ªè¡Œè»Šã€ç¸½åœ–å±¤
    const allBikeLayer = L.layerGroup([bikeLaneLayer, youbikeLayer]);

    // (4) è‡ªè¡Œè»Šåœ–ä¾‹
    const bikeLegend = L.control({ position: 'bottomright' });
    bikeLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">è‡ªè¡Œè»Šåœ–ä¾‹</div>
    <div class="item"><span style="display:inline-block;width:20px;height:2px;background:#0077cc;"></span> <span>è‡ªè¡Œè»Šé“</span></div>
    <div class="item"><img src="https://i.postimg.cc/260kqMc4/image.png" style="width:20px;height:20px;"/> <span>YouBike ç«™é»</span></div>
  `;
      return div;
    };

    // (5) åœ–å±¤é–‹é—œæ™‚æ‰é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "è‡ªè¡Œè»Š") {
        bikeLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "è‡ªè¡Œè»Š") {
        map.removeControl(bikeLegend);
      }
    });


    // #endregion


    // #region ////// å°å—å¸‚å…¬è»Š ////////
    // (1) å…¬è»Šè·¯ç·š
    const busRouteLayer = L.layerGroup();
    async function loadBusRoutes() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/V3/Map/Bus/Network/Route/City/Tainan?$format=GEOJSON";

      try {
        const res = await axios.get(url, {
          headers: { Authorization: `Bearer ${token}` }
        });

        busRouteLayer.clearLayers();

        if (res.data && res.data.type === "FeatureCollection") {
          L.geoJSON(res.data, {
            style: {
              color: "#FAA94B",   // å…¬è»Šè·¯ç·šç”¨æ©˜è‰²
              weight: 1.5,
              opacity: 0.8
            }
          }).addTo(busRouteLayer);
        }

        console.log("âœ… å…¬è»Šè·¯ç·šè¼‰å…¥å®Œæˆ");
      } catch (err) {
        console.error("âŒ å…¬è»Šè·¯ç·šè®€å–å¤±æ•—", err);
      }
    }

    // (2) å…¬è»Šç«™ä½ (ç”¨ /Bus/Station)
    const busStopLayer = L.layerGroup();
    const busStopCluster = L.markerClusterGroup();
    busStopLayer.addLayer(busStopCluster);

    async function loadBusStations() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v3/Bus/Station/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, {
          headers: { Authorization: `Bearer ${token}` }
        });

        busStopCluster.clearLayers();

        const stations = res.data?.Stations || [];   // âš¡ æ”¹é€™è£¡
        console.log("ğŸš å…¬è»Šç«™ä½æ•¸é‡ï¼š", stations.length);

        stations.forEach(st => {
          const lat = st.StationPosition?.PositionLat;
          const lon = st.StationPosition?.PositionLon;
          if (!lat || !lon) return;

          const stationName = st.StationName?.Zh_tw || "æœªçŸ¥ç«™ä½";

          const routeNames = (st.Stops || [])
            .map(s => s.RouteName?.Zh_tw || "æœªçŸ¥è·¯ç·š")
            .filter((v, i, arr) => arr.indexOf(v) === i);

          let html = `<b>${stationName}</b><br/>`;
          if (routeNames.length > 0) {
            html += "æœå‹™è·¯ç·šï¼š<br/>" + routeNames.join("<br/>");
          } else {
            html += "æš«ç„¡è·¯ç·šè³‡è¨Š";
          }

          const busStopIcon = L.icon({
            iconUrl: "https://i.postimg.cc/pdjJT1vs/image.png",
            iconSize: [45, 45],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
          });

          const marker = L.marker([lat, lon], { icon: busStopIcon })
            .bindPopup(html);

          busStopCluster.addLayer(marker);
        });

        console.log("âœ… å…¬è»Šç«™ä½è¼‰å…¥å®Œæˆ");
      } catch (err) {
        console.error("âŒ å…¬è»Šç«™ä½è®€å–å¤±æ•—", err);
      }
    }

    // (3) å…¬è»Šå‹•æ…‹å®šæ™‚è³‡æ–™ (ç”¨ /Bus/RealTimeByFrequency)
    const busRealtimeLayer = L.layerGroup();

    async function loadBusRealtime() {
      const token = await getToken(2); // ç”¨ç¬¬äºŒçµ„ API Key
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bus/RealTimeByFrequency/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, {
          headers: { Authorization: `Bearer ${token}` }
        });

        busRealtimeLayer.clearLayers();

        const buses = res.data || [];
        console.log("ğŸšŒ å…¬è»Šå‹•æ…‹æ•¸é‡ï¼š", buses.length);

        buses.forEach(bus => {
          const lat = bus.BusPosition?.PositionLat;
          const lon = bus.BusPosition?.PositionLon;
          if (!lat || !lon) return;

          const plate = bus.PlateNumb || "æœªçŸ¥è»Šè™Ÿ";
          const route = bus.RouteName?.Zh_tw || "æœªçŸ¥è·¯ç·š";
          const subRoute = bus.SubRouteName?.Zh_tw || "";
          const gpsTime = bus.GPSTime ? new Date(bus.GPSTime).toLocaleString() : "ç„¡";
          const azimuth = bus.Azimuth || 0;  // æ–¹å‘è§’ (0~360)

          // å‹•æ…‹å…¬è»Šåœ–ç¤ºï¼ˆå¸¶æ—‹è½‰ï¼‰
          const busIcon = L.divIcon({
            className: "bus-icon",
            html: `<div style="transform: rotate(${azimuth}deg);">
             <img src="https://i.postimg.cc/PrjpdnM6/image.png" 
                  style="width:35px;height:35px;"/>
           </div>`,
            iconSize: [5, 5],
            iconAnchor: [17, 17],
            popupAnchor: [0, -17]
          });

          const html = `
          <b>è»Šç‰Œï¼š</b>${plate}<br/>
          <b>è·¯ç·šï¼š</b>${route}<br/>
          ${subRoute ? `<b>å­è·¯ç·šï¼š</b>${subRoute}<br/>` : ""}
          <b>å®šä½æ™‚é–“ï¼š</b>${gpsTime}<br/>
          <b>æ–¹å‘è§’ï¼š</b>${azimuth}Â°
        `;

          L.marker([lat, lon], { icon: busIcon })
            .bindPopup(html)
            .addTo(busRealtimeLayer);
        });


        // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
        setTimeout(loadBusRealtime, 30000);

      } catch (err) {
        console.error("âŒ å…¬è»Šå‹•æ…‹è®€å–å¤±æ•—", err);
        setTimeout(loadBusRealtime, 60000);
      }
    }


    // (4) å…¬è»Šè³‡è¨Šç¸½åœ–å±¤ (åŒ…å«è·¯ç·šã€ç«™ç‰Œã€å‹•æ…‹)
    const busInfoLayer = L.layerGroup([busRouteLayer, busStopLayer, busRealtimeLayer]);

    // (5) å…¬è»Šè³‡è¨Šåœ–ä¾‹
    const busLegend = L.control({ position: 'bottomright' });
    busLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">å…¬è»Šåœ–ä¾‹</div>
    <div class="item"><span style="display:inline-block;width:30px;height:3px;background:#FAA94B;"></span> å…¬è»Šè·¯ç·š</div>
    <div class="item"><img src="https://i.postimg.cc/pdjJT1vs/image.png" width="20"/> å…¬è»Šç«™ç‰Œ</div>
    <div class="item"><img src="https://i.postimg.cc/dV000sZ9/image.png" width="20"/> å…¬è»Šå‹•æ…‹</div>
  `;
      return div;
    };

    map.on("overlayadd", function (e) {
      if (e.name === "å…¬è»Šè³‡è¨Š") {
        busLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "å…¬è»Šè³‡è¨Š") {
        map.removeControl(busLegend);
      }
    });

    // #endregion






    // #region/////////åœ–å±¤æ§åˆ¶å™¨//////////////
    // ============= åº•åœ–æ§åˆ¶å™¨ ============
    L.control.layers(basemapLayers, null, { position: 'topleft', collapsed: false }).addTo(map);

    // ============= è¡Œäººå°ˆç”¨ ============
    const cctvControl = L.control.layers(null,
      {
        "è‡ªè¡Œè»Š": allBikeLayer,
        "å…¬è»Šè³‡è¨Š": busInfoLayer
      },
      { position: 'topleft', collapsed: true });
    cctvControl.addTo(map);

    // ============= é§•é§›äººå°ˆç”¨ =============
    const eventControl = L.control.layers(null,
      {
        "CCTV": allCCTV,
        "å³æ™‚é“è·¯äº‹ä»¶": allEventsLayer

      }, { position: 'topleft', collapsed: true });
    eventControl.addTo(map);

    // === ä¿®æ”¹æ¨™é¡Œ ===
    setTimeout(() => {
      // æ‰¾åˆ° Leaflet æ§åˆ¶å™¨çš„ DOM
      const controls = document.querySelectorAll('.leaflet-control-layers');
      if (controls.length >= 3) {
        controls[1].querySelector('.leaflet-control-layers-toggle').title = "è¡Œäººå°ˆç”¨";
        controls[1].insertAdjacentHTML("afterbegin", "<div class='custom-title'>è¡Œäººå°ˆç”¨</div>");

        controls[2].querySelector('.leaflet-control-layers-toggle').title = "é§•é§›äººå°ˆç”¨";
        controls[2].insertAdjacentHTML("afterbegin", "<div class='custom-title'>é§•é§›äººå°ˆç”¨</div>");
      }
    }, 100);

    // åŸ·è¡Œ
    // CCTV(åªæŠ“ä¸€æ¬¡)
    getCCTVData();
    getCCTVData1();
    getCCTVData2();
    // é“è·¯äº‹ä»¶æœƒè‡ªå·±å¾ªç’°æ›´æ–°
    loadAllEvents();
    // YouBike
    loadBikeLane();
    loadYoubikeStations();
    updateYoubikeAvailability();
    // å…¬è»Š
    loadBusRoutes();
    loadBusStations();
    loadBusRealtime();



    // å³æ™‚è³‡è¨Š(å»¶é²&å®šæ™‚æ›´æ–°)
    setTimeout(updateYoubikeAvailability, 10000); // YouBike â†’ 10 ç§’å¾Œé–‹å§‹
    setTimeout(loadAllEvents, 20000);     // é“è·¯äº‹ä»¶ â†’ 20 ç§’å¾Œé–‹å§‹



    // #endregion



  </script>


</body>

</html>
