<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>äº¤é€šå„€è¡¨æ¿</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Esri Leaflet -->
  <script src="https://unpkg.com/esri-leaflet"></script>

  <!-- Esri Leaflet Vector (é€™å€‹æ˜¯ä½ ç¼ºçš„) -->
  <script src="https://unpkg.com/esri-leaflet-vector/dist/esri-leaflet-vector.js"></script>

  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <!-- Leaflet PIP (Point in Polygon) -->
  <script src="https://unpkg.com/leaflet-pip/leaflet-pip.min.js"></script>
  <script src="https://unpkg.com/wellknown/wellknown.js"></script>

  <!--marker clustering (ç¾¤é›†)å¥—ä»¶-->>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>


  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* ğŸš« ç¦æ­¢é é¢æ»¾å‹• */
    }

    /* æœå°‹å€å¡Š */
    #search-panel {
      height: 200px;
      /* ğŸš¨ æŠŠé«˜åº¦æ‹‰å¤§ */
      width: 100%;
      display: flex;
      background: #f8f8f8;
      border-bottom: 4px solid #BDBDBD;
      box-sizing: border-box;
      padding: 10px;
      overflow-y: auto;
      /* è‹¥æœå°‹çµæœå¾ˆå¤šï¼Œå¯ä»¥æ²å‹• */
    }



    #search-left {
      flex: 1;
    }

    #search-right {
      flex: 1;
      padding-left: 20px;
    }

    #search-result ul {
      list-style: none;
      padding: 0;
    }

    #search-result li {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }

    #search-result img {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      border: 1px solid #ddd;
      padding: 5px;
    }

    td:first-child {
      font-weight: bold;
      background: #f0f0f0;
      width: 100px;
    }


    /* åœ°åœ– */
    #map {
      height: calc(100% - 200px);
      /* åœ°åœ–è‡ªå‹•å¡«æ»¿å‰©ä¸‹ç©ºé–“ */
      width: 100%;
      font-size: 14px;
    }

    .leaflet-control {
      z-index: 2000 !important;
    }

    .mouse-position {
      background: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 14px;
    }


    .legend {
      background: rgba(255, 255, 255, .9);
      padding: 8px 10px;
      border-radius: 8px;
      line-height: 18px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      font-size: 13px;
    }

    .legend .item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .legend img {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    .legend .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #d9534f;
      border: 2px solid #fff;
      box-shadow: 0 0 4px rgba(0, 0, 0, .4);
    }

    .legend .line-swatch {
      width: 30px;
      height: 6px;
      /* ç²—ä¸€é»çš„ç·šæ®µ */
      display: inline-block;
      margin-right: 8px;
      border-radius: 3px;
    }

    .legend .title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .custom-title {
      background: #f8f9fa;
      padding: 4px 8px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }

    /*é‡æ•´*/
    #refresh-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2000;
      /* ä¿è­‰åœ¨åœ°åœ–ä¸Šæ–¹ */
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background 0.2s ease;
    }

    #refresh-btn:hover {
      background: rgba(255, 255, 255, 1);
    }

    #refresh-btn img {
      width: 28px;
      height: 28px;
      display: block;
    }
  </style>
</head>

<body>
  <div id="search-panel">
    <!-- å·¦é‚Šï¼šæ¨™é¡Œ + æœå°‹æ¡† + æœå°‹çµæœ -->
    <div id="search-left">
      <h3>åœè»Šå ´æœå°‹</h3>
      <input type="text" id="searchInput" placeholder="è¼¸å…¥åœè»Šå ´åç¨±æˆ–è·¯å" />
      <button id="searchBtn">æœå°‹</button>
      <div id="search-result"></div>
    </div>

    <!-- å³é‚Šï¼šåœè»Šå ´è©³ç´°è³‡è¨Š -->
    <div id="search-right">
      <div id="parking-info"></div>
    </div>
  </div>


  <!-- âœ… åœ°åœ– -->
  <div id="map"></div>

  <!-- é‡æ•´ -->
  <div id="refresh-btn" title="é‡æ–°æ•´ç†é é¢ï¼Œè«‹å‹¿åœ¨çŸ­æ™‚é–“å…§é€£çºŒé‡æ•´ï¼Œæœƒç™¼ç”ŸéŒ¯èª¤">
    <img src="https://i.postimg.cc/L4nrq14n/refresh.png" alt="é‡æ–°æ•´ç†" />
  </div>

  <script>
    // #region token&API
    //////////// ArcGIS API KEY ///////////
    const arcgis_apiKey = "AAPTxy8BH1VEsoebNVZXo8HurG35MoS3OvUYxFcNeS2m5JxU1AR5TGUGDBXLI8BTgkxZ8XFImL07ZrGjzL88WXWEeWRV8XgMpTRASIkKUh0ATXQcRJOdOlXp6pGgL1lW_A12BvA801o1IIFBe3DJnCBgWnqcjShpc8t_b3Nc2o75ulf6Di9mM2btfpa_fZkHZi3362RlCmTwfSMmk_mZT6jTEwVBJqm1EBVk4O9pS9-p8xE.AT1_7VueP0OE";


    /////////// TDX API KEY /////////////
    // ç¬¬ä¸€çµ„ (å°ˆé–€çµ¦ CCTVã€é“è·¯äº‹ä»¶ç”¨)
    const AppID1 = "f64114051-51c79fb9-4206-46dc";
    const AppKey1 = "f20440d9-6d85-4aa5-ab13-5389cb2a6919";

    // ç¬¬äºŒçµ„ (å°ˆé–€çµ¦ å…¬è»Šã€è‡ªè¡Œè»Šé“ã€YouBike ç”¨)
    const AppID2 = "f64114051-924181ba-6a4d-4890";
    const AppKey2 = "043fcebb-22e0-4b48-a45a-79e5fdbe2b9f";

    // ç¬¬ä¸‰çµ„ (å°ˆé–€çµ¦ åœè»Šç”¨)
    const AppID3 = "f64114051-3e23d930-5b9e-4bf7";
    const AppKey3 = "a8a9e747-baa1-450b-8aaa-1504a9d11ecb";

    // ä¸‰çµ„ token èˆ‡éæœŸæ™‚é–“
    let token1 = null, tokenExpireTime1 = 0;
    let token2 = null, tokenExpireTime2 = 0;
    let token3 = null, tokenExpireTime3 = 0;

    // å…±ç”¨çš„ getTokenï¼Œä¾ä¾†æºé¸å“ªçµ„
    async function getToken(which = 1) {
      const now = Date.now();

      // åˆ¤æ–·ä¸‰çµ„ token æ˜¯å¦éæœŸ
      if (which === 1 && token1 && now < tokenExpireTime1) return token1;
      if (which === 2 && token2 && now < tokenExpireTime2) return token2;
      if (which === 3 && token3 && now < tokenExpireTime3) return token3;

      try {
        const { data } = await axios.post(
          "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
          new URLSearchParams({
            grant_type: "client_credentials",
            client_id: which === 1 ? AppID1 : (which === 2 ? AppID2 : AppID3),
            client_secret: which === 1 ? AppKey1 : (which === 2 ? AppKey2 : AppKey3)
          }),
          { headers: { "Content-Type": "application/x-www-form-urlencoded" } }
        );

        const tk = data.access_token;
        const exp = now + (data.expires_in - 60) * 1000; // æå‰ 1 åˆ†é˜åˆ·æ–°

        if (which === 1) {
          token1 = tk; tokenExpireTime1 = exp;
        } else if (which === 2) {
          token2 = tk; tokenExpireTime2 = exp;
        } else {
          token3 = tk; tokenExpireTime3 = exp;
        }

        return tk;
      } catch (err) {
        console.error("âŒ å–å¾— Token å¤±æ•—", err.response?.data || err);
        return null;
      }
    }
    // #endregion


    // #region åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­é¡¯ç¤ºæ•´å€‹å°å—å¸‚
    // å°å—å¸‚ç¯„åœ (å·¦ä¸Š & å³ä¸‹åº§æ¨™)
    const tainanBounds = L.latLngBounds(
      [22.70, 120.00],
      [23.40, 120.65]
    );

    // å»ºç«‹åœ°åœ–ï¼Œä¸¦é™åˆ¶åœ¨å°å—å¸‚ç¯„åœ
    const map = L.map("map", {
      maxBounds: tainanBounds,
      maxBoundsViscosity: 1.0
    }).setView([23.15, 120.32], 11);  // ä¸­å¿ƒé» + zoom level
    // #endregion

    // #region åº•åœ–
    const EMap = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const orthophoto = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ' });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });
    const lightBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap & Â© CARTO',
      subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const basemapLayers = {
      "é è¨­åº•åœ–": lightBasemap,
      "è‡ºç£é€šç”¨é›»å­åœ°åœ–": EMap,
      "æ­£å°„å½±åƒåœ–": orthophoto,
      "OpenStreetMap": osm
    };


    // #endregion

    // #region////// æ»‘é¼ ä½ç½®é¡¯ç¤ºåº§æ¨™ /////////////
    var mousePositionControl = L.control({ position: 'bottomleft' });
    mousePositionControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'mouse-position');
      div.innerHTML = 'ç¶“ç·¯åº¦: ';
      return div;
    };
    mousePositionControl.addTo(map);

    map.on('mousemove', function (e) {
      var latlng = e.latlng;
      document.querySelector('.mouse-position').innerHTML =
        'ç¶“ç·¯åº¦ï¼š( ' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6) + ' )';
    });
    // #endregion

    // #region ////// å›åˆ°å°å—å¸‚éˆ• (åœ–ç¤º + å¤–æ¡†æ¡†) /////////////
    var infoControl = L.control({ position: 'bottomleft' });
    infoControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = '<img src="https://i.postimg.cc/7hvYvwPL/home.png" alt="å›åˆ°å°å—å¸‚" style="width:24px;height:24px;">';
      div.title = "å›åˆ°å°å—å¸‚ä¸­å¿ƒ";

      // å¤–æ¡†æ¨£å¼
      div.style.backgroundColor = 'rgba(0,170,170,0.5)';
      div.style.padding = '6px';
      div.style.borderRadius = '5px';
      div.style.cursor = 'pointer';
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.justifyContent = 'center';

      // æ”¹æˆ setViewï¼Œå›åˆ°å°å—å¸‚ä¸­å¿ƒé» + ç¸®æ”¾å±¤ç´š
      div.onclick = function () {
        map.setView([23.15, 120.32], 11);  // ä¸­å¿ƒé» + zoom
      };

      return div;
    };
    infoControl.addTo(map);
    // #endregion



    // #region //////å…±ç”¨å‡½å¼ï¼šé»è‡ªå‹•ç¸®æ”¾/////////
    // é€šç”¨ï¼šé»æ“Šå¾Œç¸®æ”¾ä¸¦è‡ªå‹•åˆ¤æ–·æ˜¯å¦å¾€ä¸Šåç§»
    function addZoomOnClick(marker, lat, lon, zoom = 16) {
      marker.on("click", () => {
        map.setView([lat, lon], zoom, { animate: true });
      });

      marker.on("popupopen", () => {
        setTimeout(() => {
          const popupEl = document.querySelector(".leaflet-popup-content");
          if (popupEl) {
            const popupHeight = popupEl.offsetHeight;

            // ğŸš€ æ ¹æ“š popup é«˜åº¦å‹•æ…‹ç§»å‹•ï¼Œç›´æ¥ç§»é«˜åº¦çš„ 0.8 å€
            if (popupHeight > 150) {
              const offset = popupHeight * 0.8;
              map.panBy([0, -offset]);
              console.log(`ğŸ“Œ Popup é«˜åº¦ ${popupHeight}pxï¼Œå·²å¾€ä¸Šç§» ${offset}px`);
            }
          }
        }, 200);
      });
    }


    // CCTV å°ˆç”¨ï¼šé»æ“Šå¾Œç¸®æ”¾ä¸¦å¾€ä¸Šåç§»
    function addZoomOnClickCCTV(marker, lat, lon, zoom = 16) {
      marker.on("click", () => {
        map.setView([lat, lon], zoom, { animate: true });
      });

      // popup é–‹å•Ÿå¾Œå†å¹³ç§»
      marker.on("popupopen", () => {
        setTimeout(() => {
          map.panBy([0, -150]); // âœ… å¾€ä¸Šç§» 150px
        }, 200); // å»¶é²ä¸€é»ï¼Œç­‰ popup å®šä½å¥½
      });
    }


    // å…¶ä»–
    function addZoomOnClick(marker, lat, lon, zoom = 16) {
      marker.on("click", () => {
        map.flyTo([lat, lon], zoom);
        marker.openPopup();
      });
    }

    // #endregion

    // #region ////// å°å—å¸‚å€ç•Œåœ–å±¤ ////// 
    let districtLayer; // å­˜ GeoJSON layer

    fetch("tn-town.geojson")
      .then(res => res.json())
      .then(data => {
        districtLayer = L.geoJSON(data, {
          style: function (feature) {
            if (feature.properties.TOWN === "å°å—å¸‚") {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 2,          // ç·šæ¢ç²—
                opacity: 1,
                fillOpacity: 0,     // ä¸è¦å¡«æ»¿
                dashArray: null     // å¯¦ç·š
              };
            } else {
              return {
                color: "#000000",   // é»‘è‰²
                weight: 0.7,
                opacity: 0.8,
                fillOpacity: 0,
                dashArray: "5, 5"   // è™›ç·š (5px ç·šæ®µ, 5px é–“éš”)
              };
            }
          },
          onEachFeature: function (feature, layer) {
            if (feature.properties) {
              // âš¡ ç›´æ¥é» polygon æ™‚æ‰æœƒé¡¯ç¤º popup
              layer.bindPopup("è¡Œæ”¿å€ï¼š" + (feature.properties.TOWN || "æœªçŸ¥"));
            }
          }
        }).addTo(map);

        console.log("âœ… å°å—å¸‚å€ç•Œè¼‰å…¥å®Œæˆ");
      })
      .catch(err => console.error("âŒ è¼‰å…¥å€ç•Œå¤±æ•—", err));
    // #endregion

    // #region ////// åˆ¤æ–·éœ€ä¸éœ€æ›´æ–° ///////
    // ç”¨ä¾†è¨˜éŒ„å„åœ–å±¤æœ€å¾Œæ›´æ–°æ™‚é–“
    const lastUpdate = {};

    // é€šç”¨åˆ¤æ–·å·¥å…·
    function shouldUpdate(layerKey, newTime) {
      if (!newTime) return true; // æ²’æ™‚é–“ â†’ ç…§æ¨£æ›´æ–°
      if (lastUpdate[layerKey] === newTime) {
        console.log(`âš ï¸ ${layerKey} è³‡æ–™ç„¡è®ŠåŒ–ï¼Œè·³éæ›´æ–°`);
        return false;
      }
      lastUpdate[layerKey] = newTime;
      return true;
    }
    // #endregion

    // #region///////// CCTV /////////////////
    // CCTV åœ–å±¤ï¼ˆé è¨­éƒ½ä¸åŠ åˆ°åœ°åœ–ï¼‰
    const cityCCTVLayer = L.layerGroup();      // å°å—å¸‚
    const highwayCCTVLayer = L.layerGroup();   // åœ‹é“/é«˜é€Ÿ
    const provinceCCTVLayer = L.layerGroup();  // çœé“

    // CCTV ç¸½é–‹é—œï¼šæŠŠä¸‰å€‹å­åœ–å±¤ç´å…¥ä¸€å€‹ LayerGroup
    const allCCTV = L.layerGroup([
      cityCCTVLayer,
      highwayCCTVLayer,
      provinceCCTVLayer
    ]);

    // icon
    var cctvIcon = new L.Icon({ iconUrl: 'https://i.postimg.cc/XvSCdW0M/CCTV.png', iconSize: [30, 30] }); // å¸‚å€
    var cctvIcon1 = new L.Icon({ iconUrl: 'https://i.postimg.cc/4y0yH2L2/CCTV.png', iconSize: [30, 30] });                       // é«˜é€Ÿ
    var cctvIcon2 = new L.Icon({ iconUrl: 'https://i.postimg.cc/mgPPHCGP/CCTV.png', iconSize: [30, 30] });                       // çœé“

    // ğŸ“Œ å…±ç”¨ï¼šå»ºç«‹ CCTV popup (æœƒå‹•æ…‹æ›´æ–°æ™‚é–“)
    function createCCTVPopup(roadName, videoUrl) {
      const popupId = "popup-" + Math.random().toString(36).substr(2, 9);

      const html = `
    <div style="min-width:380px;">
      <div id="${popupId}" style="text-align:right;font-size:12px;color:#666;margin-bottom:2px;">
        æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString()}
      </div>
      <img src="${videoUrl}" width="380" height="240" style="display:block;"/>
    </div>
  `;

      // æ¯ç§’æ›´æ–° popup è£¡çš„æ™‚é–“
      setInterval(() => {
        const el = document.getElementById(popupId);
        if (el) {
          el.innerText = new Date().toLocaleString();
        }
      }, 1000);

      return `è·¯åï¼š${roadName}</br>${html}`;
    }

    // å¸‚å€ CCTV //
    async function getCCTVData() {
      const token = await getToken(1);
      if (!token) return;

      axios.get("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Tainan?$format=JSON", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(res => {

        if (!shouldUpdate("cctv", res.data?.UpdateTime)) {
          setTimeout(getCCTVData, 300000);
          return;
        }

        (res.data.CCTVs || []).forEach(c => {
          const marker = L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon })
            .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
            .addTo(cityCCTVLayer);
          addZoomOnClickCCTV(marker, c.PositionLat, c.PositionLon);
        });
        setTimeout(getCCTVData, 300000);
      }).catch(err => console.error("âŒ å¸‚å€ CCTV è®€å–å¤±æ•—", err));
      setTimeout(getCCTVData, 300000);
    }

    // é«˜é€Ÿå…¬è·¯ CCTV //
    async function getCCTVData1() {
      const token = await getToken(1);
      if (!token) return;

      let url1 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
      axios.get(url1, { headers: { Authorization: `Bearer ${token}` } })
        .then(res1 => {
          const cctvs = res1.data.CCTVs || res1.data.FreewayCCTVs || [];
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          filtered.forEach(c => {
            const marker = L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon1 })
              .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
              .addTo(highwayCCTVLayer);
            addZoomOnClickCCTV(marker, c.PositionLat, c.PositionLon);
          });
          setTimeout(getCCTVData1, 300000);
        })
        .catch(err => console.error("âŒ é«˜é€Ÿå…¬è·¯ CCTV è®€å–å¤±æ•—", err));
      setTimeout(getCCTVData1, 300000);
    }

    // çœé“ CCTV //
    async function getCCTVData2() {
      const token = await getToken(1);
      if (!token) return;

      let url2 = 'https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?$format=JSON';
      axios.get(url2, { headers: { Authorization: `Bearer ${token}` } })
        .then(res2 => {
          const cctvs = res2.data.CCTVs || [];
          const filtered = cctvs.filter(c =>
            c.PositionLat >= 22.887 && c.PositionLat <= 23.413 &&
            c.PositionLon >= 120.007 && c.PositionLon <= 120.627
          );

          filtered.forEach(c => {
            const marker = L.marker([c.PositionLat, c.PositionLon], { icon: cctvIcon2 })
              .bindPopup(createCCTVPopup(c.RoadName, c.VideoStreamURL), { maxWidth: "640", maxHeight: "480" })
              .addTo(provinceCCTVLayer);
            addZoomOnClickCCTV(marker, c.PositionLat, c.PositionLon);
          });
        })
        .catch(err => console.error("âŒ çœé“ CCTV è®€å–å¤±æ•—", err));
    }


    // CCTV åœ–ä¾‹ï¼ˆå¸‚å€/é«˜é€Ÿ/çœé“ï¼‰
    const cctvLegend = L.control({ position: 'bottomright' });
    cctvLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">CCTV åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/XvSCdW0M/CCTV.png" alt="å¸‚å€ CCTV"> <span>å¸‚å€ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/4y0yH2L2/CCTV.png" alt="åœ‹é“/é«˜é€Ÿ CCTV"> <span>åœ‹é“/é«˜é€Ÿ CCTV</span></div>
    <div class="item"><img src="https://i.postimg.cc/mgPPHCGP/CCTV.png" alt="çœé“ CCTV"> <span>çœé“ CCTV</span></div>
  `;
      return div;
    };
    // åªåœ¨ã€ŒCCTVï¼ˆå…¨éƒ¨ï¼‰ã€æ‰“é–‹æ™‚é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "CCTV") {
        cctvLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "CCTV") {
        map.removeControl(cctvLegend);
      }
    });


    // #endregion


    // #region////// å³æ™‚é“è·¯äº‹ä»¶ /////////////
    // å»ºç«‹ä¸‰å€‹å­åœ–å±¤
    const cityEventsLayer = L.layerGroup();
    const freewayEventsLayer = L.layerGroup();
    const highwayEventsLayer = L.layerGroup();

    // åˆä½µæˆä¸€å€‹ç¸½åœ–å±¤
    const allEventsLayer = L.layerGroup([
      cityEventsLayer,
      freewayEventsLayer,
      highwayEventsLayer
    ]);

    // WKT è§£æ
    function parseWKTPoint(wkt) {
      if (!wkt || !wkt.startsWith("POINT")) return null;
      const nums = wkt.replace(/POINT\s*\(|\)/g, "").trim().split(/\s+/).map(Number);
      if (nums.length !== 2 || nums.some(isNaN)) return null;
      const [lon, lat] = nums;
      return [lat, lon]; // Leaflet æ ¼å¼
    }

    // æ™‚é–“æ ¼å¼å°å·¥å…·
    function fmtTime(iso) {
      try {
        return new Date(iso).toLocaleString();
      } catch {
        return iso || "";
      }
    }

    // é™åˆ¶ç¯„åœ (å°å—å¸‚å¤§æ¦‚ç¯„åœ)
    function isInTainan(lat, lon) {
      return lat >= 22.887 && lat <= 23.413 &&
        lon >= 120.007 && lon <= 120.627;
    }

    // é¸ icon
    function getEventIcon(desc) {
      let url;
      if (desc && desc.includes("è»Šç¦")) {
        url = "https://i.postimg.cc/KvcjXzmv/image.png";
      } else if (desc && desc.includes("æ–½å·¥")) {
        url = "https://i.postimg.cc/fTHLMNb7/image.png";
      } else if (desc && desc.includes("ç½å®³")) {
        url = "https://i.postimg.cc/0NS2GK0Z/image.png";
      }
      if (url) {
        return L.icon({ iconUrl: url, iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
      } else {
        return L.divIcon({
          className: 'live-event-icon',
          html: '<div style="width:14px;height:14px;border-radius:50%;background:#d9534f;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,.4)"></div>',
          iconSize: [14, 14], iconAnchor: [7, 7]
        });
      }
    }

    // å…±ç”¨çš„äº‹ä»¶è¼‰å…¥ function
    async function loadEvents(url, targetLayer) {
      const token = await getToken(1);
      if (!token) return;

      try {
        const { data } = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        targetLayer.clearLayers();

        if (!shouldUpdate("cms", resLive.data?.UpdateTime)) {
          setTimeout(loadEvents, 600000);
          return;
        }

        const events = data?.LiveEvents || [];
        events.forEach(ev => {
          const latlng = parseWKTPoint(ev.Positions);
          if (!latlng) return;
          if (!isInTainan(latlng[0], latlng[1])) return; // é™åˆ¶å°å—ç¯„åœ

          const popupHtml = `
        <div style="min-width:220px">
          <div style="font-weight:700;margin-bottom:4px">${ev.EventTitle || "é“è·¯äº‹ä»¶"}</div>
          ${ev.Description ? `<div>å…§å®¹ï¼š${ev.Description}</div>` : ""}
          ${ev?.Location?.Other ? `<div>åœ°é»ï¼š${ev.Location.Other}</div>` : ""}
          ${ev.Source ? `<div>ä¾†æºï¼š${ev.Source}</div>` : ""}
          ${ev.PublishTime ? `<div style="color:#666;font-size:12px">ç™¼å¸ƒæ™‚é–“ï¼š${fmtTime(ev.PublishTime)}</div>` : ""}
          ${ev.LastUpdateTime ? `<div style="color:#666;font-size:12px">æ›´æ–°æ™‚é–“ï¼š${fmtTime(ev.LastUpdateTime)}</div>` : ""}

        </div>
      `;
          const marker = L.marker(latlng, { icon: getEventIcon(ev.Description) })
            .bindPopup(popupHtml)
            .addTo(targetLayer);
          addZoomOnClick(marker, latlng[0], latlng[1]);
        });

        // è¨­å®šè‡ªå‹•åˆ·æ–°
        const intervalSec = Number(data?.UpdateInterval) || 60;
        setTimeout(() => loadEvents(url, targetLayer), intervalSec * 1000);

      } catch (err) {
        console.error("âŒ é“è·¯äº‹ä»¶è®€å–å¤±æ•—", url, err);
        setTimeout(() => loadEvents(url, targetLayer), 600000); //ååˆ†é˜æ›´æ–°
      }
    }

    // å•Ÿå‹•ä¸‰å€‹ä¾†æº
    function loadAllEvents() {
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/City/Tainan?$format=JSON", cityEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Freeway?$format=JSON", freewayEventsLayer);
      loadEvents("https://tdx.transportdata.tw/api/basic/v1/Traffic/RoadEvent/LiveEvent/Highway?$format=JSON", highwayEventsLayer);
    }

    // å³æ™‚é“è·¯äº‹ä»¶åœ–ä¾‹
    // å»ºç«‹åœ–ä¾‹ï¼ˆä½†å…ˆä¸è¦åŠ åˆ° mapï¼‰
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">äº‹ä»¶åœ–ä¾‹</div>
    <div class="item"><img src="https://i.postimg.cc/KvcjXzmv/image.png" alt="è»Šç¦"> <span>è»Šç¦</span></div>
    <div class="item"><img src="https://i.postimg.cc/fTHLMNb7/image.png" alt="æ–½å·¥"> <span>æ–½å·¥</span></div>
    <div class="item"><img src="https://i.postimg.cc/0NS2GK0Z/image.png" alt="ç½å®³"> <span>ç½å®³</span></div>
    <div class="item"><span class="dot"></span> <span>å…¶ä»–äº‹ä»¶</span></div>
  `;
      return div;
    };
    // ç•¶ä½¿ç”¨è€…ã€Œæ‰“é–‹ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        legend.addTo(map);
      }
    });
    // ç•¶ä½¿ç”¨è€…ã€Œé—œé–‰ã€å³æ™‚é“è·¯äº‹ä»¶åœ–å±¤ â†’ ç§»é™¤åœ–ä¾‹
    map.on("overlayremove", function (e) {
      if (e.name === "å³æ™‚é“è·¯äº‹ä»¶") {
        map.removeControl(legend);
      }
    });
    // #endregion


    // #region ////// å°å—å¸‚ å…¬å…±è‡ªè¡Œè»Š ////////
    // (1) è‡ªè¡Œè»Šé“
    const bikeLaneLayer = L.layerGroup();

    async function loadBikeLane() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/V3/Map/Bike/Network/CityBike/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        bikeLaneLayer.clearLayers();

        res.data.forEach(item => {
          if (item.Geometry) {
            try {
              const geojson = wellknown(item.Geometry); // æŠŠ WKT è½‰æˆ GeoJSON
              L.geoJSON(geojson, {
                style: { color: "#0077cc", weight: 2, opacity: 0.9 }
              }).addTo(bikeLaneLayer);
            } catch (e) {
              console.warn("âš ï¸ WKT è§£æå¤±æ•—", item.Geometry);
            }
          }
        });

        console.log("âœ… è‡ªè¡Œè»Šé“è¼‰å…¥å®Œæˆï¼Œç­†æ•¸ï¼š", res.data.length);
      } catch (err) {
        console.error("âŒ è‡ªè¡Œè»Šé“è®€å–å¤±æ•—", err);
      }
    }

    // (2) å…¬å…±è‡ªè¡Œè»Š (YouBike)
    const youbikeLayer = L.layerGroup();
    const youbikeCluster = L.markerClusterGroup({
      disableClusteringAtZoom: 15,  // ğŸ“ æ”¾å¤§åˆ° 15 ç´šä»¥ä¸Šæ™‚è‡ªå‹•æ‹†é–‹
      spiderfyOnMaxZoom: true,      // ğŸ“ é»æ“Šç¾¤é›†æ™‚å±•é–‹é¡¯ç¤ºå€‹åˆ¥é»
      showCoverageOnHover: true    // ğŸ“ ç§»åˆ°ç¾¤é›†ä¸Šé¡¯ç¤ºè—è‰²è¦†è“‹ç¯„åœ
    });
    youbikeLayer.addLayer(youbikeCluster);

    const youbikeIcon = L.icon({
      iconUrl: "https://i.postimg.cc/260kqMc4/image.png", // ç«™é» icon
      iconSize: [45, 45],
      iconAnchor: [14, 28],
      popupAnchor: [0, -28]
    });

    // æš«å­˜ marker (ç”¨ StationUID å°æ‡‰)
    let youbikeMarkers = new Map();

    async function loadYoubikeStations() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });

        if (!shouldUpdate("youbike", res.data?.UpdateTime)) {
          setTimeout(updateYoubikeAvailability, 300000);
          return;
        }

        const stations = res.data || [];
        console.log("ğŸš² YouBike ç«™é»æ•¸é‡ï¼š", stations.length);

        youbikeCluster.clearLayers();
        youbikeMarkers.clear();

        stations.forEach(st => {
          const lat = st.StationPosition?.PositionLat;
          const lon = st.StationPosition?.PositionLon;
          if (!lat || !lon) return;

          const name = st.StationName?.Zh_tw || "æœªçŸ¥ç«™é»";

          const marker = L.marker([lat, lon], { icon: youbikeIcon })
            .bindPopup(`<b>${name}</b><br/>è¼‰å…¥ä¸­...`);

          marker._stationUID = st.StationUID;

          youbikeCluster.addLayer(marker);
          youbikeMarkers.set(st.StationUID, marker);
          addZoomOnClick(marker, lat, lon);
        });

      } catch (err) {
        console.error("âŒ YouBike ç«™é»è®€å–å¤±æ•—", err);
      }
    }

    async function updateYoubikeAvailability() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Tainan?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const avail = res.data || [];

        avail.forEach(item => {
          const marker = youbikeMarkers.get(item.StationUID);
          if (!marker) return;

          const name = marker.getPopup().getContent().split("<br/>")[0];
          marker.bindPopup(`
        ${name}<br/>
        å¯ç§Ÿå€Ÿï¼š${item.AvailableRentBikes}<br/>
        å¯æ­¸é‚„ï¼š${item.AvailableReturnBikes}<br/>
        æ›´æ–°æ™‚é–“ï¼š${new Date(item.UpdateTime).toLocaleTimeString()}
      `);
        });

        // æ¯ 300 ç§’æ›´æ–°ä¸€æ¬¡
        setTimeout(updateYoubikeAvailability, 300000);

      } catch (err) {
        console.error("âŒ YouBike è»Šä½æ›´æ–°å¤±æ•—", err);
        setTimeout(updateYoubikeAvailability, 300000);
      }
    }

    // (3) åˆä½µæˆã€Œè‡ªè¡Œè»Šã€ç¸½åœ–å±¤
    const allBikeLayer = L.layerGroup([bikeLaneLayer, youbikeLayer]);

    // (4) è‡ªè¡Œè»Šåœ–ä¾‹
    const bikeLegend = L.control({ position: 'bottomright' });
    bikeLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">è‡ªè¡Œè»Šåœ–ä¾‹</div>
    <div class="item"><span style="display:inline-block;width:30px;height:2px;background:#0077cc;"></span> <span>è‡ªè¡Œè»Šé“</span></div>
    <div class="item"><img src="https://i.postimg.cc/260kqMc4/image.png" style="width:30px;height:30px;"/> <span>YouBike ç«™é»</span></div>
  `;
      return div;
    };

    // (5) åœ–å±¤é–‹é—œæ™‚æ‰é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.name === "å…¬å…±è‡ªè¡Œè»Šè³‡è¨Š") {
        bikeLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "å…¬å…±è‡ªè¡Œè»Šè³‡è¨Š") {
        map.removeControl(bikeLegend);
      }
    });


    // #endregion


    // #region ////// å°å—å¸‚å…¬è»Š ////////

    // (0) æš«å­˜ ETA è³‡æ–™
    let busETAData = new Map();

    // (1) å…¬è»Šè·¯ç·š
    const busRouteLayer = L.layerGroup();
    async function loadBusRoutes() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/V3/Map/Bus/Network/Route/City/Tainan?$format=GEOJSON";
      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });

        busRouteLayer.clearLayers();

        if (res.data && res.data.type === "FeatureCollection") {
          L.geoJSON(res.data, {
            style: {
              color: "#FAA94B",   // å…¬è»Šè·¯ç·šç”¨æ©˜è‰²
              weight: 1.5,
              opacity: 0.8
            }
          }).addTo(busRouteLayer);
        }

        console.log("âœ… å…¬è»Šè·¯ç·šè¼‰å…¥å®Œæˆ");
      } catch (err) {
        console.error("âŒ å…¬è»Šè·¯ç·šè®€å–å¤±æ•—", err);
      }
    }

    // (2) å…¬è»Šç«™ä½
    const busStopLayer = L.layerGroup();
    const busStopCluster = L.markerClusterGroup({
      disableClusteringAtZoom: 15,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: true
    });
    busStopLayer.addLayer(busStopCluster);

    async function loadBusStations() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v3/Bus/Station/City/Tainan?$format=JSON";
      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });

        busStopCluster.clearLayers();

        const stations = res.data?.Stations || [];
        console.log("ğŸš å…¬è»Šç«™ä½æ•¸é‡ï¼š", stations.length);

        stations.forEach(st => {
          const lat = st.StationPosition?.PositionLat;
          const lon = st.StationPosition?.PositionLon;
          if (!lat || !lon) return;

          const stationName = st.StationName?.Zh_tw || "æœªçŸ¥ç«™ä½";

          const busStopIcon = L.icon({
            iconUrl: "https://i.postimg.cc/pdjJT1vs/image.png",
            iconSize: [45, 45],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
          });

          const marker = L.marker([lat, lon], { icon: busStopIcon })
            .bindPopup(() => {
              const etas = busETAData.get(st.StationUID) || [];
              let etaHtml = "";

              if (etas.length > 0) {
                etaHtml = "<br/><b>åˆ°ç«™é ä¼°ï¼š</b><br/>" + etas.slice(0, 5).map(e => {
                  if (e.EstimateTime > 0) {
                    const min = Math.round(e.EstimateTime / 60);
                    return `${e.RouteName.Zh_tw} â†’ ${min} åˆ†é˜`;
                  } else {
                    // åˆ¤æ–· StopStatus
                    let statusText = "";
                    switch (e.StopStatus) {
                      case 0:
                      case 1: statusText = "å°šæœªç™¼è»Š"; break;
                      case 2: statusText = "äº¤ç®¡ä¸åœé "; break;
                      case 3: statusText = "ä»Šæ—¥æœªç‡Ÿé‹"; break;
                      case 4: statusText = "æœ«ç­è»Šå·²é"; break;
                      default: statusText = "æš«ç„¡è³‡è¨Š";
                    }
                    return `${e.RouteName.Zh_tw} â†’ ${statusText}`;
                  }
                }).join("<br/>");
              } else {
                etaHtml = "<br/>æš«ç„¡åˆ°ç«™è³‡è¨Š";
              }

              return `<b>${stationName}</b>${etaHtml}`;
            });


          busStopCluster.addLayer(marker);
          addZoomOnClick(marker, lat, lon);
        });


        console.log("âœ… å…¬è»Šç«™ä½è¼‰å…¥å®Œæˆ");
      } catch (err) {
        console.error("âŒ å…¬è»Šç«™ä½è®€å–å¤±æ•—", err);

      }
    }


    // (3) å…¬è»Š ETA
    async function loadBusETAs() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v3/Bus/EstimatedTimeOfArrival/City/Tainan?$format=JSON";
      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const etas = res.data?.N1Datas || [];

        if (!shouldUpdate("busETA", res.data?.UpdateTime)) {
          setTimeout(loadBusETAs, 120000);
          return;
        }
        console.log("âœ… å…¬è»Š ETA ç­†æ•¸ï¼š", etas.length);

        busETAData.clear();
        etas.forEach(e => {
          if (!e.StopUID) return;
          if (!busETAData.has(e.StopUID)) busETAData.set(e.StopUID, []);
          busETAData.get(e.StopUID).push(e);
        });

        // æ¯ 120 ç§’æ›´æ–°
        setTimeout(loadBusETAs, 120000);

      } catch (err) {
        console.error("âŒ å…¬è»Š ETA è®€å–å¤±æ•—", err);
        setTimeout(loadBusETAs, 120000);
      }
    }

    // (4) å…¬è»Šå‹•æ…‹
    const busRealtimeLayer = L.layerGroup();

    async function loadBusRealtime() {
      const token = await getToken(2);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Bus/RealTimeByFrequency/City/Tainan?$format=JSON";
      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });

        // âœ… åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°
        if (!shouldUpdate("busRealtime", res.data?.[0]?.GPSTime)) {
          setTimeout(loadBusRealtime, 120000);
          return;
        }

        busRealtimeLayer.clearLayers();

        const buses = res.data || [];
        console.log("ğŸšŒ å…¬è»Šå‹•æ…‹æ•¸é‡ï¼š", buses.length);

        buses.forEach(bus => {
          const lat = bus.BusPosition?.PositionLat;
          const lon = bus.BusPosition?.PositionLon;
          if (!lat || !lon) return;

          const plate = bus.PlateNumb || "æœªçŸ¥è»Šè™Ÿ";
          const route = bus.RouteName?.Zh_tw || "æœªçŸ¥è·¯ç·š";
          const subRoute = bus.SubRouteName?.Zh_tw || "";
          const gpsTime = bus.GPSTime ? new Date(bus.GPSTime).toLocaleString() : "ç„¡";
          const azimuth = bus.Azimuth || 0;

          const busIcon = L.divIcon({
            className: "bus-icon",
            html: `<div style="transform: rotate(${azimuth}deg);">
                 <img src="https://i.postimg.cc/PrjpdnM6/image.png" style="width:35px;height:35px;"/>
               </div>`,
            iconSize: [5, 5],
            iconAnchor: [17, 17],
            popupAnchor: [0, -17]
          });

          const html = `
        <b>è»Šç‰Œï¼š</b>${plate}<br/>
        <b>è·¯ç·šï¼š</b>${route}<br/>
        ${subRoute ? `<b>å­è·¯ç·šï¼š</b>${subRoute}<br/>` : ""}
        <b>å®šä½æ™‚é–“ï¼š</b>${gpsTime}<br/>
        <b>æ–¹å‘è§’ï¼š</b>${azimuth}Â°
      `;

          const marker = L.marker([lat, lon], { icon: busIcon })
            .bindPopup(html);

          busRealtimeLayer.addLayer(marker);
          addZoomOnClick(marker, lat, lon);
        });

        setTimeout(loadBusRealtime, 120000);

      } catch (err) {
        console.error("âŒ å…¬è»Šå‹•æ…‹è®€å–å¤±æ•—", err);
        setTimeout(loadBusRealtime, 120000);
      }
    }

    // (5) å…¬è»Šè³‡è¨Šç¸½åœ–å±¤
    const busInfoLayer = L.layerGroup([busRouteLayer, busStopLayer, busRealtimeLayer]);

    // (6) å…¬è»Šåœ–ä¾‹
    const busLegend = L.control({ position: 'bottomright' });
    busLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
    <div class="title">å…¬è»Šåœ–ä¾‹</div>
    <div class="item"><span style="display:inline-block;width:30px;height:3px;background:#FAA94B;"></span> å…¬è»Šè·¯ç·š</div>
    <div class="item"><img src="https://i.postimg.cc/pdjJT1vs/image.png" style="width:30px;height:30px"/> å…¬è»Šç«™ç‰Œ</div>
    <div class="item"><img src="https://i.postimg.cc/dV000sZ9/image.png" style="width:30px;height:30px"/> å…¬è»Šå‹•æ…‹</div>
  `;
      return div;
    };
    map.on("overlayadd", function (e) {
      if (e.name === "å…¬è»Šè³‡è¨Š") busLegend.addTo(map);
    });
    map.on("overlayremove", function (e) {
      if (e.name === "å…¬è»Šè³‡è¨Š") map.removeControl(busLegend);
    });


    // #endregion


    // #region /////// åœè»Šä½ ///////////
    // åœè»Šé»ä½ç¾¤é›†
    const parkingLayer = L.layerGroup();
    const parkingCluster = L.markerClusterGroup({
      maxClusterRadius: 40,         // ğŸ“ ç¾¤é›†åŠå¾‘ï¼Œæ•¸å€¼è¶Šå° â†’ ç¾¤é›†è®Šå¤š
      disableClusteringAtZoom: 17,  // ğŸ“ æ”¾å¤§åˆ° 15 ç´šä»¥ä¸Šæ™‚è‡ªå‹•æ‹†é–‹
      spiderfyOnMaxZoom: true,      // ğŸ“ é»æ“Šç¾¤é›†æ™‚å±•é–‹é¡¯ç¤ºå€‹åˆ¥é»
      showCoverageOnHover: true    // ğŸ“ ç§»åˆ°ç¾¤é›†ä¸Šä¸é¡¯ç¤ºè—è‰²è¦†è“‹ç¯„åœ
    });
    parkingLayer.addLayer(parkingCluster);

    // åœè»Šå ´ icon
    const parkingIcon = L.icon({
      iconUrl: "https://i.postimg.cc/hP94LZRY/parking.png", // è‡ªè¨‚åœè»Šåœ–ç¤º
      iconSize: [35, 35],
      iconAnchor: [17, 35],
      popupAnchor: [0, -35]
    });

    // 1ï¸âƒ£ å ´å…§åœè»Šå ´ (åŸºæœ¬è³‡æ–™ + å³æ™‚å‰©é¤˜ä½)
    async function loadOffStreetParking() {
      const token = await getToken(3);
      if (!token) return;

      const urlBase = "https://tdx.transportdata.tw/api/basic/v1/Parking/OffStreet/CarPark/City/Tainan?$format=JSON";
      const urlAvail = "https://tdx.transportdata.tw/api/basic/v1/Parking/OffStreet/ParkingAvailability/City/Tainan?$format=JSON";

      try {
        const [resBase, resAvail] = await Promise.all([
          axios.get(urlBase, { headers: { Authorization: `Bearer ${token}` } }),
          axios.get(urlAvail, { headers: { Authorization: `Bearer ${token}` } }),
        ]);

        if (!shouldUpdate("offStreet", resAvail.data?.UpdateTime)) {
          setTimeout(loadOffStreetParking, 300000); // 3 åˆ†é˜å¾Œå†è·‘
          return;
        }

        const base = resBase.data?.CarParks || [];
        const avail = resAvail.data?.ParkingAvailabilities || [];

        base.forEach((park) => {
          const lat = park.CarParkPosition?.PositionLat;
          const lon = park.CarParkPosition?.PositionLon;
          if (lat == null || lon == null) return;

          const match = avail.find(a => String(a.CarParkID) === String(park.CarParkID));

          const name = park.CarParkName?.Zh_tw || "æœªçŸ¥åœè»Šå ´";
          const total = match?.TotalSpaces ?? "æœªçŸ¥";
          const available = match?.AvailableSpaces ?? "æœªçŸ¥";

          // å®‰å…¨è™•ç†æ™‚é–“
          let updateText = "ç„¡";
          const u = match?.DataCollectTime || match?.UpdateTime;
          if (u) {
            const d = new Date(u);
            if (!isNaN(d)) updateText = d.toLocaleString();
          }

          const html = `
        <b>${name}</b><br/>
        ç¸½è»Šä½æ•¸ï¼š${total}<br/>
        å‰©é¤˜è»Šä½æ•¸ï¼š${available}<br/>
        æ›´æ–°æ™‚é–“ï¼š${updateText}
      `;

          // ğŸ”¸ æ­£ç¢ºå®£å‘Š markerï¼Œä¸¦åŠ å…¥ç¾¤é›† & ç´¢å¼•
          const marker = L.marker([lat, lon], { icon: parkingIcon })
            .bindPopup(html)
            .addTo(parkingCluster);
          addZoomOnClick(marker, lat, lon);

          // é€™è¡Œè¦å­˜åœ¨ï¼ˆä½ å‰é¢å·²ç¶“æœ‰ registerParkingMarkerï¼‰
          registerParkingMarker(lat, lon, marker);
        });

        console.log("âœ… å ´å…§åœè»Šå ´è¼‰å…¥å®Œæˆ");
        setTimeout(loadOffStreetParking, 300000);
      } catch (err) {
        console.error("âŒ å ´å…§åœè»Šå ´è®€å–å¤±æ•—", err);
        setTimeout(loadOffStreetParking, 300000);
      }
    }


    // 2ï¸âƒ£ è·¯é‚Šåœè»Šå ´ (åŸºæœ¬è³‡æ–™ + ç¸½æ ¼æ•¸ + å³æ™‚å‰©é¤˜ä½)
    async function loadOnStreetParking() {
      const token = await getToken(3);
      if (!token) return;

      const urlBase = "https://tdx.transportdata.tw/api/basic/v1/Parking/OnStreet/ParkingSegment/City/Tainan?$format=JSON";
      const urlSpace = "https://tdx.transportdata.tw/api/basic/v1/Parking/OnStreet/ParkingSegmentSpace/City/Tainan?$format=JSON";
      const urlAvail = "https://tdx.transportdata.tw/api/basic/v1/Parking/OnStreet/ParkingSegmentAvailability/City/Tainan?$format=JSON";

      try {
        const [resBase, resSpace, resAvail] = await Promise.all([
          axios.get(urlBase, { headers: { Authorization: `Bearer ${token}` } }),
          axios.get(urlSpace, { headers: { Authorization: `Bearer ${token}` } }),
          axios.get(urlAvail, { headers: { Authorization: `Bearer ${token}` } }),
        ]);

        if (!shouldUpdate("onStreet", resAvail.data?.UpdateTime)) {
          setTimeout(loadOnStreetParking, 300000);
          return;
        }


        const base = resBase.data?.ParkingSegments || [];
        // æœ‰äº›è³‡æ–™æ¬„ä½æ˜¯ Crubâ€¦ æœ‰äº›æ˜¯ Curbâ€¦ å…©å€‹éƒ½å®¹éŒ¯è™•ç†
        const spaces = resSpace.data?.CrubSegmentParkingSpaces || resSpace.data?.CurbSegmentParkingSpaces || [];
        const avails = resAvail.data?.CurbParkingSegmentAvailabilities || [];

        base.forEach((seg) => {
          const lat = seg.ParkingSegmentPosition?.PositionLat;
          const lon = seg.ParkingSegmentPosition?.PositionLon;
          if (lat == null || lon == null) return;

          const matchSpace = spaces.find(s => String(s.ParkingSegmentID) === String(seg.ParkingSegmentID));
          const matchAvail = avails.find(a => String(a.ParkingSegmentID) === String(seg.ParkingSegmentID));

          const name = seg.ParkingSegmentName?.Zh_tw || "æœªçŸ¥è·¯æ®µ";
          const total = matchAvail?.TotalSpaces ?? matchSpace?.TotalSpaces ?? "æœªçŸ¥";
          const available = matchAvail?.AvailableSpaces ?? "æœªçŸ¥";

          // å®‰å…¨è™•ç†æ™‚é–“
          let updateText = "ç„¡";
          const u = matchAvail?.DataCollectTime || matchAvail?.UpdateTime;
          if (u) {
            const d = new Date(u);
            if (!isNaN(d)) updateText = d.toLocaleString();
          }

          const html = `
        <b>${name}</b><br/>
        ç¸½è»Šä½æ•¸ï¼š${total}<br/>
        å‰©é¤˜è»Šä½æ•¸ï¼š${available}<br/>
        æ›´æ–°æ™‚é–“ï¼š${updateText}
      `;

          // ğŸ”¸ æ­£ç¢ºå®£å‘Š markerï¼Œä¸¦åŠ å…¥ç¾¤é›† & ç´¢å¼•
          const marker = L.marker([lat, lon], { icon: parkingIcon })
            .bindPopup(html)
            .addTo(parkingCluster);
          addZoomOnClick(marker, lat, lon);

          // é€™è¡Œè¦å­˜åœ¨ï¼ˆä½ å‰é¢å·²ç¶“æœ‰ registerParkingMarkerï¼‰
          registerParkingMarker(lat, lon, marker);
        });

        console.log("âœ… è·¯é‚Šåœè»Šè¼‰å…¥å®Œæˆ");
        setTimeout(loadOnStreetParking, 300000);
      } catch (err) {
        console.error("âŒ è·¯é‚Šåœè»Šä½è®€å–å¤±æ•—", err);
        setTimeout(loadOnStreetParking, 300000);
      }
    }

    // 3ï¸âƒ£ åœè»Šåœ–ä¾‹
    const parkingLegend = L.control({ position: "bottomright" });
    parkingLegend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
    <div class="title">åœè»Šå ´</div>
    <div class="item"><img src="https://i.postimg.cc/hP94LZRY/parking.png" width="20"/> åœè»Šä½</div>
  `;
      return div;
    };
    map.on("overlayadd", function (e) {
      if (e.name === "åœè»Šè³‡è¨Š") {
        parkingLegend.addTo(map);
      }
    });
    map.on("overlayremove", function (e) {
      if (e.name === "åœè»Šè³‡è¨Š") {
        map.removeControl(parkingLegend);
      }
    });

    // 4ï¸âƒ£ åˆä½µæˆç¸½åœ–å±¤
    const allParkingLayer = L.layerGroup([parkingLayer]);

    // #endregion

    // #region /////// æœå°‹åœè»Šä½ //////////
    let offStreetData = [];
    let onStreetData = [];

    // ä»¥ã€Œç¶“ç·¯åº¦å­—ä¸²ã€ç´¢å¼•åŸæœ¬åœ°åœ–ä¸Šçš„ markerï¼Œæœå°‹é»æ“Šæ™‚å¥½å®šä½
    const markerIndex = new Map(); // key: "lat,lng" -> Leaflet Marker
    function keyLatLng(lat, lng) {
      return `${Number(lat).toFixed(6)},${Number(lng).toFixed(6)}`;
    }
    function registerParkingMarker(lat, lng, marker) {
      markerIndex.set(keyLatLng(lat, lng), marker);
    }
    function findMarker(lat, lng) {
      return markerIndex.get(keyLatLng(lat, lng)) || null;
    }

    // åªæŠ“åŸºæœ¬è³‡æ–™ï¼ˆåç¨±/åœ°å€/åº§æ¨™â€¦ï¼‰ä¾›æœå°‹ç”¨ï¼›æ¨¡ç³Šæœå°‹ç”¨ includesï¼Œä¸åˆ†å¤§å°å¯«
    async function loadOffStreet() {
      const url = "https://tdx.transportdata.tw/api/basic/v1/Parking/OffStreet/CarPark/City/Tainan?$format=JSON";
      const res = await axios.get(url);
      offStreetData = (res.data.CarParks || []).map(p => ({
        id: p.CarParkID,
        type: "å ´å…§åœè»Šå ´",
        name: p.CarParkName?.Zh_tw || "",
        address: p.Address || "",
        lat: p.CarParkPosition?.PositionLat,
        lng: p.CarParkPosition?.PositionLon,
        desc: p.Description || "",
        fare: p.FareDescription || ""
      }));
    }

    async function loadOnStreet() {
      const url = "https://tdx.transportdata.tw/api/basic/v1/Parking/OnStreet/ParkingSegment/City/Tainan?$format=JSON";
      const res = await axios.get(url);
      onStreetData = (res.data.ParkingSegments || []).map(p => ({
        id: p.ParkingSegmentID,
        type: "è·¯é‚Šåœè»Šå ´",
        name: p.ParkingSegmentName?.Zh_tw || "",
        address: p.Description || "", // ä¾‹å¦‚ã€Œå°æ±è·¯è‡³ä¸­å±±å—è·¯ã€
        lat: p.ParkingSegmentPosition?.PositionLat,
        lng: p.ParkingSegmentPosition?.PositionLon,
        desc: p.Description || "",
        fare: p.FareDescription || ""
      }));
    }

    // æœå°‹åŠŸèƒ½ (æ”¯æ´ä¸­æ–‡æ¨¡ç³Šæ¯”å°ï¼Œä¸ä½¿ç”¨ toLowerCase)
    function searchParking(keyword) {
      const k = keyword.trim();
      if (!k) return [];

      const f = (p) =>
        (p.name && p.name.includes(k)) ||
        (p.address && p.address.includes(k));

      const r1 = offStreetData.filter(f);
      const r2 = onStreetData.filter(f);

      console.log("æœå°‹é—œéµå­—:", k, "å ´å…§ç­†æ•¸:", r1.length, "è·¯é‚Šç­†æ•¸:", r2.length);
      return [...r1, ...r2];
    }


    // ç”¨ createElement + appendChildï¼ˆâŒ ä¸è¦å†æ··ç”¨ innerHTML += ç ´å£äº‹ä»¶ç¶å®šï¼‰
    function showResults(results) {
      const resultDiv = document.getElementById("search-result");
      const infoDiv = document.getElementById("parking-info");
      resultDiv.innerHTML = "";
      infoDiv.innerHTML = "";

      if (!results.length) {
        resultDiv.textContent = "æ‰¾ä¸åˆ°ç›¸é—œåœè»Šå ´";
        return;
      }

      const ul = document.createElement("ul");

      results.forEach((p) => {
        const li = document.createElement("li");

        const btn = document.createElement("img");
        btn.src = "https://i.postimg.cc/c4bSzTKs/image.png";
        btn.alt = "å®šä½åˆ°åœ°åœ–";

        const label = document.createElement("span");
        label.innerHTML = `<b>${p.name}</b> (${p.type}) - ${p.address}`;

        btn.addEventListener("click", () => {
          // ğŸš© ç¢ºä¿åœè»Šè³‡è¨Šåœ–å±¤å·²ç¶“æ‰“é–‹
          if (!map.hasLayer(allParkingLayer)) {
            map.addLayer(allParkingLayer);
          }

          // 1) åœ°åœ–å®šä½ + åŸ marker é–‹ popup
          const marker = findMarker(p.lat, p.lng);
          map.setView([p.lat, p.lng], 17);
          if (marker && marker.openPopup) marker.openPopup();

          // 2) å·¦å´åªé¡¯ç¤ºè¢«é»é¸çš„é‚£ç­† + æŒ‰éˆ•
          resultDiv.innerHTML = `
            <div style="display:flex;align-items:center;gap:6px;">
              <img src="https://i.postimg.cc/c4bSzTKs/image.png" 
                  alt="icon" style="width:20px;height:20px;">
              <span><b>${p.name}</b> (${p.type}) - ${p.address}</span>
            </div>
            <div style="margin-top:6px;">
              <button id="backToListBtn">å›åˆ°æ¸…å–®</button>
              <button id="clearBtn">æ¸…é™¤</button>
            </div>
          `;

          // 3) å³å´è¡¨æ ¼
          infoDiv.innerHTML = `
    <table>
      <tr><td>åç¨±</td><td>${p.name}</td></tr>
      <tr><td>é¡å‹</td><td>${p.type}</td></tr>
      <tr><td>åœ°å€/è·¯æ®µ</td><td>${p.address}</td></tr>
      <tr><td>æ”¶è²»è³‡è¨Š</td><td>${p.fare}</td></tr>
      <tr><td>æè¿°</td><td>${p.desc}</td></tr>
    </table>
  `;

          // ç¶å®šå·¦å´æŒ‰éˆ•
          document.getElementById("backToListBtn")?.addEventListener("click", () => {
            showResults(window._lastResults || []);
          });
          document.getElementById("clearBtn")?.addEventListener("click", clearSearch);
        });


        li.appendChild(btn);
        li.appendChild(label);
        ul.appendChild(li);
      });

      resultDiv.appendChild(ul);
      window._lastResults = results;
    }

    function clearSearch() {
      document.getElementById("search-result").innerHTML = "";
      document.getElementById("parking-info").innerHTML = "";
      document.getElementById("searchInput").value = "";
    }

    function doSearch() {
      const keyword = document.getElementById("searchInput").value || "";
      showResults(searchParking(keyword));
    }

    document.getElementById("searchBtn").addEventListener("click", doSearch);
    document.getElementById("searchInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") doSearch();
    });

    // åˆå§‹åŒ–ï¼šå…ˆæŠŠæœå°‹ç”¨çš„éœæ…‹è³‡æ–™æŠ“å¥½
    async function initData() {
      await loadOffStreet();
      await loadOnStreet();
      console.log("è³‡æ–™è¼‰å…¥å®Œæˆ âœ… å ´å…§:", offStreetData.length, " è·¯é‚Š:", onStreetData.length);
    }
    initData();
    // #endregion

    // #region /////// äº¤é€šæµé‡åœ– ////////
    const trafficLayer = L.esri.dynamicMapLayer({
      url: "https://traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",
      opacity: 0.8,
      f: "image",
      useCors: true,
      token: arcgis_apiKey
    });

    // å»ºç«‹åœ–ä¾‹
    const trafficLegend = L.control({ position: "bottomright" });

    trafficLegend.onAdd = function (map) {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
    <div class="title">äº¤é€šç‹€æ³</div>
    <div class="item"><span class="line-swatch" style="background:#86D2B8;"></span>æµæš¢</div>
    <div class="item"><span class="line-swatch" style="background:#EFA332;"></span>ç¨å£…å¡</div>
    <div class="item"><span class="line-swatch" style="background:#EAD76F;"></span>æ™®é€š</div>
    <div class="item"><span class="line-swatch" style="background:#E62E53;"></span>å£…å¡</div>
    <div class="item"><span class="line-swatch" style="background:#C3C3C3;"></span>ç„¡è³‡æ–™</div>
    <div class="item"><img src="https://i.postimg.cc/L5WtZkGm/image.png" width="20" height="20"> æ„Ÿæ¸¬å™¨</div>
    <div class="item"><small>æ›´æ–°æ™‚é–“ï¼š<span id="traffic-update-time">${new Date().toLocaleTimeString()}</span></small></div>
  `;
      return div;
    };


    // ç•¶äº¤é€šæµé‡åœ–å±¤è¢«æ‰“é–‹æ™‚ â†’ é¡¯ç¤ºåœ–ä¾‹
    map.on("overlayadd", function (e) {
      if (e.layer === trafficLayer) {
        trafficLegend.addTo(map);
      }
    });

    // ç•¶äº¤é€šæµé‡åœ–å±¤è¢«é—œé–‰æ™‚ â†’ ç§»é™¤åœ–ä¾‹
    map.on("overlayremove", function (e) {
      if (e.layer === trafficLayer) {
        map.removeControl(trafficLegend);
      }
    });

    // æ¯ 8 åˆ†é˜ refresh ä¸€æ¬¡ & æ›´æ–°æ™‚é–“
    setInterval(() => {
      if (map.hasLayer(trafficLayer)) {
        trafficLayer.refresh();
        const el = document.getElementById("traffic-update-time");
        if (el) el.textContent = new Date().toLocaleTimeString();
        console.log("âœ… Traffic layer refreshed:", new Date().toLocaleTimeString());
      }
    }, 8 * 60 * 1000);
    // #endregion

    // #region ////// CMS (å¯è®Šè³‡è¨Šæ¨™èªŒ) //////

    // å»ºç«‹åœ–å±¤
    const cmsLayer = L.layerGroup();

    // CMS icon
    const cmsIcon = L.icon({
      iconUrl: "https://i.postimg.cc/vZ81d2Bk/CMS.png", // ä½ å¯ä»¥æ›æˆè‡ªå·±çš„åœ–ç¤º
      iconSize: [50, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20]
    });

    // æš«å­˜å³æ™‚è³‡è¨Š (ç”¨ CMSID ç•¶ key)
    let cmsLiveMap = new Map();

    // æŠ“ CMS é»ä½
    async function loadCMSPoints() {
      const token = await getToken(3);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CMS/Highway?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const cmsPoints = res.data?.CMSs || [];

        cmsLayer.clearLayers();

        cmsPoints.forEach(cms => {
          const lat = cms.PositionLat;
          const lon = cms.PositionLon;
          if (!(lat >= 22.8 && lat <= 23.5 && lon >= 120.0 && lon <= 120.7)) return;

          const cmsid = cms.CMSID;
          const roadName = cms.RoadName || "æœªçŸ¥é“è·¯";
          const direction = cms.RoadDirection || "";

          const marker = L.marker([lat, lon], { icon: cmsIcon })
            .bindPopup(() => {
              const live = cmsLiveMap.get(cmsid);
              let msgHtml = "";

              if (live && live.Messages && live.Messages.length > 0) {
                msgHtml = live.Messages.map(m => {
                  // âš¡ åŠ å…¥ -99 åˆ¤æ–·
                  if (m.Text === "-99" || m.Text === "" || m.Text == null) {
                    return `<div>æš«ç„¡è³‡è¨Š</div>`;
                  }
                  return `<div style="color:red;">${m.Text}</div>`;
                }).join("");
              } else {
                msgHtml = "æš«ç„¡è¨Šæ¯";
              }

              return `
            <b>CMS æ¨™èªŒ</b><br/>
            é“è·¯ï¼š${roadName} ${direction}<br/>
            ${msgHtml}
          `;
            });

          cmsLayer.addLayer(marker);
          addZoomOnClick(marker, lat, lon);
        });

        console.log("âœ… CMS é»ä½è¼‰å…¥å®Œæˆï¼š", cmsPoints.length);
      } catch (err) {
        console.error("âŒ CMS é»ä½è®€å–å¤±æ•—", err);
      }
    }

    // æŠ“ CMS å³æ™‚è³‡è¨Š
    async function loadCMSLive() {
      const token = await getToken(3);
      if (!token) return;

      const url = "https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/Live/CMS/Highway?$format=JSON";

      try {
        const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });
        const cmsLives = res.data?.CMSLives || [];

        cmsLiveMap.clear();
        cmsLives.forEach(live => {
          cmsLiveMap.set(live.CMSID, live);
        });

        console.log("âœ… CMS å³æ™‚è³‡è¨Šè¼‰å…¥å®Œæˆï¼š", cmsLives.length);

        // æ¯ 10 åˆ†é˜æ›´æ–°
        setTimeout(loadCMSLive, 600000);
      } catch (err) {
        console.error("âŒ CMS å³æ™‚è³‡è¨Šè®€å–å¤±æ•—", err);
        setTimeout(loadCMSLive, 120000);
      }
    }

    // åˆå§‹åŒ–
    async function initCMS() {
      await loadCMSPoints();
      await loadCMSLive();
    }
    // #endregion

    // #region //////// é‡æ•´ ///////////
    document.getElementById("refresh-btn").addEventListener("click", () => {
      // é‡æ–°æ•´ç†é é¢
      location.reload();
    });
    // #endregion


    // #region/////////åœ–å±¤æ§åˆ¶å™¨//////////////
    // åº•åœ–æ§åˆ¶å™¨
    const basemapControl = L.control.layers(basemapLayers, null, {
      position: 'topleft',
      collapsed: true   // âœ… é è¨­æ”¶åˆ
    }).addTo(map);

    // === è‡ªè¨‚æ¨™é¡Œ ===
    setTimeout(() => {
      const controls = document.querySelectorAll('.leaflet-control-layers');
      if (controls.length > 0) {
        const baseCtrl = controls[0]; // ç¬¬ä¸€å€‹é€šå¸¸å°±æ˜¯åº•åœ–æ§åˆ¶å™¨

        // åŠ ä¸Šè‡ªè¨‚æ¨™é¡Œ
        baseCtrl.insertAdjacentHTML("afterbegin", "<div class='custom-title'>åº•åœ–</div>");
      }
    }, 100);


    // ============= è¡Œäººå°ˆç”¨ ============
    const cctvControl = L.control.layers(null,
      {
        "å…¬å…±è‡ªè¡Œè»Šè³‡è¨Š": allBikeLayer,
        "å…¬è»Šè³‡è¨Š": busInfoLayer
      },
      { position: 'topleft', collapsed: true });
    cctvControl.addTo(map);


    // ============= é§•é§›äººå°ˆç”¨ =============
    const eventControl = L.control.layers(null,
      {
        "CCTV": allCCTV,
        "å³æ™‚é“è·¯äº‹ä»¶": allEventsLayer,
        "åœè»Šè³‡è¨Š": allParkingLayer,
        "CMS æ¨™èªŒ": cmsLayer,
        "å³æ™‚è·¯æ³": trafficLayer
      }, { position: 'topleft', collapsed: true });
    eventControl.addTo(map);


    // === éš±è—é è¨­å°åœ–ç¤º + åŠ ä¸Šè‡ªè¨‚æ¨™é¡Œèˆ‡å° icon ===
    setTimeout(() => {
      const controls = document.querySelectorAll('.leaflet-control-layers');

      if (controls.length > 1) {
        const pedCtrl = controls[1];
        const togglePed = pedCtrl.querySelector('.leaflet-control-layers-toggle');
        if (togglePed) togglePed.style.display = "none";

        // åŠ ä¸Šæ¨™é¡Œ + icon
        pedCtrl.insertAdjacentHTML("afterbegin", `
      <div class='custom-title'>
        è¡Œäººå°ˆç”¨ <img src="https://i.postimg.cc/tgy6qZGm/walk.png" style="width:16px;height:16px;vertical-align:middle;margin-left:4px;">
      </div>
    `);
      }

      if (controls.length > 2) {
        const drvCtrl = controls[2];
        const toggleDrv = drvCtrl.querySelector('.leaflet-control-layers-toggle');
        if (toggleDrv) toggleDrv.style.display = "none";

        // åŠ ä¸Šæ¨™é¡Œ + icon
        drvCtrl.insertAdjacentHTML("afterbegin", `
      <div class='custom-title'>
        é§•é§›äººå°ˆç”¨ <img src="https://i.postimg.cc/ZnrBz4Dh/sports-car.png" style="width:16px;height:16px;vertical-align:middle;margin-left:4px;">
      </div>
    `);
      }
    }, 100);


    // åŸ·è¡Œ
    // CCTV(åªæŠ“ä¸€æ¬¡)
    getCCTVData();
    getCCTVData1();
    getCCTVData2();
    // é“è·¯äº‹ä»¶æœƒè‡ªå·±å¾ªç’°æ›´æ–°
    loadAllEvents();
    // YouBike
    loadBikeLane();
    loadYoubikeStations();
    updateYoubikeAvailability();
    // å…¬è»Š
    async function initBus() {
      await loadBusRoutes();
      await loadBusStations();
      await loadBusETAs();
      await loadBusRealtime();
    }

    // å•Ÿå‹•
    initBus();


    // åœè»Šä½
    loadOffStreetParking();
    loadOnStreetParking();
    // CMS
    initCMS();


    // å³æ™‚è³‡è¨Š(å»¶é²&å®šæ™‚æ›´æ–°)
    setTimeout(updateYoubikeAvailability, 10000); // YouBike â†’ 10 ç§’å¾Œé–‹å§‹
    setTimeout(loadAllEvents, 20000);     // é“è·¯äº‹ä»¶ â†’ 20 ç§’å¾Œé–‹å§‹



    // #endregion



  </script>


</body>

</html>
